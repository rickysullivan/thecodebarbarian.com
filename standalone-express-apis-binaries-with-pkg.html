<!DOCTYPE html><html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>Standalone Express API Binaries with pkg | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"><link href="/style/style.css" rel="stylesheet" type="text/css"><link href="/style/github.css" rel="stylesheet" type="text/css"><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="Standalone Express API Binaries with pkg"><meta property="og:url" content="http://www.thecodebarbarian.com/standalone-express-apis-binaries-with-pkg"><meta property="og:image" content="http://i.imgur.com/oW5ZLCn.png"><meta property="og:site_name" content="The Code Barbarian"><meta property="description" content="[pkg](https://www.npmjs.com/package/pkg) is [Zeit](http://thecodebarbarian.com/building-a-nextjs-app-with-mongodb.html)'s (the company behind [Next.js](http://thecodebarbarian.com/building-a-nextjs-app-with-mongodb.html)) new tool for bundling Node.js projects into standalone binary executables. A standalone executable has numerous advantages: as long as you're on a compatible OS, you can run the executable without installing Node.js, docker, or any other runtime. You can ship your executable to a vanilla EC2 instance and run it without any extra setup, no need to maintain [AMIs](http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html) or use [Packer](https://www.packer.io/intro/). You can also [cross-compile](https://www.npmjs.com/package/pkg#targets) with pkg, so you can build an OSX-compatible executable on your Linux box and vice-versa. In other words, pkg gives you the best parts of [Golang](https://dave.cheney.net/2015/08/22/cross-compilation-with-go-1-5) in Node.js."><meta name="twitter:image" content="http://i.imgur.com/oW5ZLCn.png"></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li><li><a href="/recommendations">recommendations</a></li></ul></div></div><div class="navbar" id="nav"><div class="container"><div class="navbar-header"><a class="navbar-brand big-brand" href="http://thecodebarbarian.com"><img class="logo" src="/images/Barbarian_Head.png"><span class="site-name">The Code Barbarian</span></a></div><div class="navbar-right collapse navbar-collapse" id="home-nav-mobile"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li><a href="/tag/vue.html">Vue</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div class="col-lg-3 col-lg-offset-9 right-bar" id="desktop-right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div></p></div></div></div></div></div><div class="container-fluid hidden-sm hidden-md hidden-lg" id="mobile-sharing-options"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a class="social" href="#disqus_thread"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div class="post-sharing-options hidden-xs pull-left" id="desktop-sharing-options"><ul class="list-unstyled"><li class="twitter-share"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">Standalone Express API Binaries with pkg</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">May 03, 2017</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>

<div class="native-banner"></div>
</div><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CVAIKKQM&placement=carbonadsnet" id="_carbonads_js"></script><div class="post-body-text-container"><p><a href="https://www.npmjs.com/package/pkg">pkg</a> is <a href="http://thecodebarbarian.com/building-a-nextjs-app-with-mongodb.html">Zeit</a>&#39;s (the company behind <a href="http://thecodebarbarian.com/building-a-nextjs-app-with-mongodb.html">Next.js</a>) new tool for bundling Node.js projects into standalone binary executables. A standalone executable has numerous advantages: as long as you&#39;re on a compatible OS, you can run the executable without installing Node.js, docker, or any other runtime. You can ship your executable to a vanilla EC2 instance and run it without any extra setup, no need to maintain <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AMIs.html">AMIs</a> or use <a href="https://www.packer.io/intro/">Packer</a>. You can also <a href="https://www.npmjs.com/package/pkg#targets">cross-compile</a> with pkg, so you can build an OSX-compatible executable on your Linux box and vice-versa. In other words, pkg gives you the best parts of <a href="https://dave.cheney.net/2015/08/22/cross-compilation-with-go-1-5">Golang</a> in Node.js.</p>
<p>pkg is far from the first tool to do standalone executables for node. I&#39;ve used <a href="https://www.npmjs.com/package/lone">lone</a> with solid results since 2014, however, lone&#39;s docs and functionality are limited in scope compared to pkg&#39;s. Plus, the Zeit team has built a track record for producing elegant and well-documented products, so I&#39;m eager to give pkg a short as an alternative to my current least favorite everyday dev tool: <a href="https://www.docker.com/">Docker</a>.</p>
<h2 id="compiling-an-express-api">Compiling an Express API</h2>
<p>You can find <a href="https://github.com/vkarpov15/pkgtest">the Express app with pkg-based build system on GitHub</a>. The <code>src</code> directory contains a rudimentary Express app that uses <a href="http://thecodebarbarian.com/80-20-guide-to-async-await-in-node.js.html">async/await</a>, so this project needs Node.js 7.6.0. The <code>src/index.js</code> file exports a function that takes <code>config</code> as a parameter, connects to the MongoDB instance that <code>config</code> specifies, and starts an API server on the port that <code>config</code> specifies.</p>
<p><a href="http://i.imgur.com/8fVDeUK.png"><img src="http://i.imgur.com/8fVDeUK.png"></a></p>
<p>The Express API is identical to the one from my <a href="http://thecodebarbarian.com/building-a-nextjs-app-with-mongodb.html">Next.js reading list app</a>. It exposes 3 endpoints, one for getting a list of books, one for adding a new book, and one for deleting a book, using <a href="http://npmjs.org/package/archetype-js">archetype</a> for lightweight data validation.</p>
<p><a href="http://i.imgur.com/BE4Mf32.png"><img src="http://i.imgur.com/BE4Mf32.png"></a></p>
<p>The actual Express API is structured so it is easy to bootstrap with multiple configs, <strong>without</strong> relying on environment variables. I&#39;m wary of using environment variables in Node.js because, like all global state, it can have nasty and unintended side effects. Express itself has several places where it switches behavior based on the <code>NODE_ENV</code> environment variable, and <a href="https://expressjs.com/en/advanced/best-practice-performance.html#set-nodeenv-to-production">the effects are only documented under &quot;advanced usage&quot;</a>. If you&#39;re an advanced Express user you can work around this, but if you&#39;re a casual user of a library built on top of Express, you can be in for a nasty surprise. And that&#39;s not counting the other node modules: the trivial <code>pkgtest</code> app has 31 instances of <code>NODE_ENV</code> in its <code>node_modules</code> directory according to <code>grep -r &quot;NODE_ENV&quot; node_modules/* | wc -l</code>, and I have no idea what the vast majority of them are.</p>
<p><a href="http://i.imgur.com/nBIf5S9.png"><img src="http://i.imgur.com/nBIf5S9.png"></a></p>
<p>Better for configuration to explicit rather than &quot;surprise, I&#39;m breaking your code in production because undocumented <a href="https://github.com/facebook/react-native/pull/7878">best practice, duh</a>!&quot;</p>
<img src="http://i.imgur.com/kuCuFtY.png">

<h2 id="bundling-express-app-and-config-with-pkg">Bundling Express App and Config With pkg</h2>
<p>As far as I know <code>pkg</code> doesn&#39;t support the <a href="https://nodejs.org/api/cli.html#cli_r_require_module">Node.js <code>-r</code> flag</a> so to support multiple configs you need multiple entry points to your application. In this case, one for dev and one for prod, that each pull different configs. Here&#39;s the dev entrypoint:</p>
<p><a href="http://i.imgur.com/KzuvIQs.png"><img src="http://i.imgur.com/KzuvIQs.png"></a></p>
<p>And the prod entrypoint:</p>
<p><a href="http://i.imgur.com/Fc6mWsm.png"><img src="http://i.imgur.com/Fc6mWsm.png"></a></p>
<p>So to run the API with dev configs, as long as you have Node installed, all you need to do is run <code>node .</code>, or <code>npm start</code> with the help of <code>package.json</code>. To run the API with prod configs, you run <code>node ./.prod/app.js</code>. In practice, you&#39;d store your prod configs in a separate repo so you can isolate permissions, and use <code>npm</code> to <a href="http://thecodebarbarian.com/github-is-my-favorite-private-npm-registry">list your API server&#39;s GitHub repo as a dependency</a>, but since this is just a quick example, I&#39;m keeping the prod config in the same repo.</p>
<p>In order to use pkg to build an <code>app.dev</code> executable with the dev config and an <code>app</code> executable with the prod config, you need 2 separate <code>build-dev</code> and <code>build-prod</code> scripts that use <code>index.js</code> and <code>.prod/app.js</code> as entry points, respectively:</p>
<pre><code class="language-javascript">
{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"pkgtest"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"1.0.0"</span>,
  <span class="hljs-string">"description"</span>: <span class="hljs-string">"Rudimentary API packaged with pkg"</span>,
  <span class="hljs-string">"author"</span>: <span class="hljs-string">"Valeri Karpov &lt;val@karpov.io&gt;"</span>,
  <span class="hljs-string">"license"</span>: <span class="hljs-string">"ISC"</span>,
  <span class="hljs-string">"dependencies"</span>: {
    <span class="hljs-string">"archetype-js"</span>: <span class="hljs-string">"0.6.1"</span>,
    <span class="hljs-string">"body-parser"</span>: <span class="hljs-string">"1.17.1"</span>,
    <span class="hljs-string">"co"</span>: <span class="hljs-string">"4.6.0"</span>,
    <span class="hljs-string">"express"</span>: <span class="hljs-string">"4.15.2"</span>,
    <span class="hljs-string">"mongodb"</span>: <span class="hljs-string">"2.2.26"</span>
  },
  <span class="hljs-string">"devDependencies"</span>: {
    <span class="hljs-string">"pkg"</span>: <span class="hljs-string">"3.0.1"</span>
  },
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"build-dev"</span>: <span class="hljs-string">"pkg -t latest-linux-x64 -o ./app.dev ./index.js"</span>,
    <span class="hljs-string">"build-prod"</span>: <span class="hljs-string">"pkg -t latest-linux-x64 -o ./app ./.prod/app.js"</span>,
    <span class="hljs-string">"start"</span>: <span class="hljs-string">"node ."</span>
  }
}</code></pre>
<p>Now, when you run <code>npm run build-prod</code>, you get a single executable <code>app</code> that you can run on any compatible Linux distro, without installing Node.js or running <code>npm install</code>. It also has configs bundled, so no need for a container to isolate environment variables. Just throw the executable onto a vanilla Linux VM from EC2, Azure, DigitalOcean, or cloud provider of your choice and it all works!</p>
<p>Also, building with pkg is relatively fast and produces a 38 MB executable. Nothing to write home about, but certainly better than docker&#39;s famously slow builds and minimum ~643MB for the officially supported Node.js image.</p>
<pre><code>$ time npm run build-prod

&gt; pkgtest@1.0.0 build-prod
&gt; pkg -t latest-linux-x64 -o ./app ./.prod/app.js


real    0m3.466s
user    0m2.938s
sys    0m0.506s
$ ls -al | grep &quot;app&quot;
-rwxrwxr-x   1 val val 38674432 May  3 16:16 app
$</code></pre><h2 id="moving-on">Moving On</h2>
<p>I&#39;m not switching wholesale off of Docker for all my prod use cases anytime soon, but I like what I see so far with pkg. At the very least, I&#39;m eager to start using it for dev use cases, because I&#39;m not nearly good enough with Docker to teach junior devs how to use it well. Pkg even has support for <a href="https://github.com/zeit/pkg#config">bundling assets</a>, so instead of sharing a docker container with MongoDB, I can use tools like <a href="https://www.npmjs.com/package/mongodb-topology-manager">mongodb-version-manager</a> to send standalone executables that start and manage MongoDB replica sets and sharded clusters with no configuration. Give pkg a shot and see what new ideas you can come up with!</p>
<p><em>As you saw in this blog post, async/await is powerful, but <a href="http://thecodebarbarian.com/80-20-guide-to-async-await-in-node.js.html">limited to Node.js &gt;= 7.6.0</a>. If you&#39;re stuck using Node.js 4.x or 6.x because of LTS (especially since <a href="https://github.com/nodejs/CTC/issues/99">Node.js 8 is delayed</a>), you can still use similar patterns with ES6 generators and <a href="http://npmjs.org/package/co">co</a>. If you&#39;re looking for a much deeper dive into co, including how to write your own co replacement from scratch, check out my ebook, <a href="http://es2015generators.com/">The 80/20 Guide to ES2015 Generators</a></em></p>
<p><a href="http://es2015generators.com"><img width="200" src="http://i.imgur.com/iBT2ZEw.png"/></a></p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/#{post.src.substr('./lib/posts/'.length)}">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname
}));</script><link rel="stylesheet" href="/style/inlinecpc.css"></body></html>