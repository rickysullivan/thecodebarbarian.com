<!DOCTYPE html><html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>Getting Started With Google Cloud Functions and MongoDB | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"><link href="/style/style.css" rel="stylesheet" type="text/css"><link href="/style/github.css" rel="stylesheet" type="text/css"><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="Getting Started With Google Cloud Functions and MongoDB"><meta property="og:url" content="http://www.thecodebarbarian.com/getting-started-with-google-cloud-functions-and-mongodb"><meta property="og:image" content="https://i.imgur.com/RVPygN1.jpg"><meta property="og:site_name" content="The Code Barbarian"><meta property="description" content="Serverless architectures are becoming increasingly popular, and with good"><meta name="twitter:image" content="https://i.imgur.com/RVPygN1.jpg"></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li><li><a href="/recommendations">recommendations</a></li></ul></div></div><div class="navbar" id="nav"><div class="container"><div class="navbar-header"><a class="navbar-brand big-brand" href="http://thecodebarbarian.com"><img class="logo" src="/images/Barbarian_Head.png"><span class="site-name">The Code Barbarian</span></a></div><div class="navbar-right collapse navbar-collapse" id="home-nav-mobile"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li><a href="/tag/vue.html">Vue</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div class="col-lg-3 col-lg-offset-9 right-bar" id="desktop-right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div></p></div></div></div></div></div><div class="container-fluid hidden-sm hidden-md hidden-lg" id="mobile-sharing-options"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a class="social" href="#disqus_thread"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div class="post-sharing-options hidden-xs pull-left" id="desktop-sharing-options"><ul class="list-unstyled"><li class="twitter-share"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">Getting Started With Google Cloud Functions and MongoDB</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">April 25, 2018</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>

<div class="native-banner"></div>
</div><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CVAIKKQM&placement=carbonadsnet" id="_carbonads_js"></script><div class="post-body-text-container"><p>Serverless architectures are becoming increasingly popular, and with good
reason. In my experience, container-based orchestration frameworks have a
steep learning curve and are overkill for most consumer-facing companies.
With <a href="https://martinfowler.com/articles/serverless.html">FaaS architectures</a>, like <a href="https://www.mongodb.com/blog/post/serverless-development-with-nodejs-aws-lambda-mongodb-atlas">AWS Lambda</a> and <a href="http://thecodebarbarian.com/getting-started-with-azure-functions-and-mongodb.html">Azure Functions</a>, in theory the
only devops you need is bundling and uploading your app.</p>
<p>This article will walk you through setting up a Google Cloud Function in Node.js that connects to MongoDB. However, one major limitation of
stateless functions is the need to establish a separate database connection every time the stateless function runs, which incurs a major performance penalty.
Unfortunately, I haven&#39;t been able to figure out how to reuse a database connection
in Google Cloud Functions, the trick that works for <a href="http://thecodebarbarian.com/getting-started-with-ibm-cloud-functions-and-mongodb.html">IBM Cloud</a>, <a href="http://thecodebarbarian.com/getting-started-with-azure-functions-and-mongodb.html">Azure Functions</a>, and <a href="https://www.mongodb.com/blog/post/serverless-development-with-nodejs-aws-lambda-mongodb-atlas">AWS Lambda</a> does <strong>not</strong> work for Google Cloud Functions.</p>
<h2 id="hello-world-in-google-cloud-functions">&quot;Hello, World&quot; in Google Cloud Functions</h2>
<p>Go to the <a href="https://cloud.google.com/functions/">Google Cloud Functions landing page</a> and click &quot;Try it free&quot;.</p>
<img src="https://i.imgur.com/lSzijLZ.png">

<p>Click on the hamburger icon in the upper left and find the &quot;Cloud Functions&quot; link in the sidebar, then click &quot;Create function&quot;.</p>
<img src="https://i.imgur.com/cVNm44O.png">

<p>Name your function &quot;hello-world&quot; and leave the rest of the options in the
&quot;Create function&quot; form unchanged. Leave &quot;Function to execute&quot; as &quot;helloWorld&quot;,
because that needs to match the name of the function your code exports. Below
is the code you should enter in, so you can confirm what version of Node.js
your function is running on.</p>
<pre><code class="language-javascript">exports.helloWorld = (req, res) =&gt; {
  res.send(<span class="hljs-string">'Hello from Node.js '</span> + process.version);
};</code></pre>
<img src="https://i.imgur.com/OpJymV1.png">

<p>Click &quot;Create&quot; and wait for Google to deploy your cloud function.
Once your function is deployed, click on it to display the function&#39;s details.</p>
<img src="https://i.imgur.com/sRMnHMY.png">

<p>Click the &quot;Trigger&quot; tab to find your cloud function&#39;s URL.</p>
<img src="https://i.imgur.com/r3rvHUy.png">

<p>Copy the URL and use <a href="https://en.wikipedia.org/wiki/CURL">curl</a> to run your cloud function.</p>
<pre><code>$ curl https://us-central1-test21-201718.cloudfunctions.net/hello-world
Hello from Node.js v6.11.5
$  </code></pre><p>Google Cloud Functions don&#39;t give you any control over what version of Node.js you run,
they run Node.js v6.11.5 currently. You can&#39;t use async/await natively on Google
Cloud Functions at the time of this writing.</p>
<h2 id="connecting-to-mongodb-atlas">Connecting to MongoDB Atlas</h2>
<p>Click on the &quot;Source&quot; tab in the function details and hit the &quot;Edit&quot; button.
You&#39;ll notice there&#39;s 2 files in your source code, one of which is <code>package.json</code>.
Edit <code>package.json</code> to match the below code.</p>
<pre><code>{
  &quot;name&quot;: &quot;sample-http&quot;,
  &quot;version&quot;: &quot;0.0.1&quot;,
  &quot;dependencies&quot;: {
    &quot;co&quot;: &quot;4.6.0&quot;,
    &quot;mongodb&quot;: &quot;3.x&quot;
  }
}</code></pre><img src="https://i.imgur.com/E4uBqOf.png">

<p>Once you redeploy, Google Cloud will automatically install your npm dependencies
for you. Now, change your <code>index.js</code> to match the below code, replacing the <code>uri</code>
with your <a href="https://www.mongodb.com/cloud/atlas">MongoDB Atlas</a> URI.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> co = <span class="hljs-built_in">require</span>(<span class="hljs-string">'co'</span>);
<span class="hljs-keyword">const</span> mongodb = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>);

<span class="hljs-keyword">const</span> uri = <span class="hljs-string">'ATLAS_URI_HERE'</span>;

exports.helloWorld = (req, res) =&gt; {
  co(<span class="hljs-function"><span class="hljs-keyword">function</span>*(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">yield</span> mongodb.MongoClient.connect(uri);

    <span class="hljs-keyword">const</span> docs = <span class="hljs-keyword">yield</span> client.db(<span class="hljs-string">'test'</span>).collection(<span class="hljs-string">'tests'</span>).find().toArray();
    res.send(<span class="hljs-string">'Result: '</span> + <span class="hljs-built_in">JSON</span>.stringify(docs));
  }).catch(error =&gt; {
    res.send(<span class="hljs-string">'Error: '</span> + error.toString());
  });
};</code></pre>
<img src="https://i.imgur.com/8udyX2v.png">

<p>Click &quot;Save&quot; to deploy your function. Once it is deployed, you should be able
to curl your cloud function and get a document from <a href="https://www.mongodb.com/cloud/atlas">MongoDB Atlas</a> back.</p>
<pre><code>$ curl https://us-central1-test21-201718.cloudfunctions.net/hello-world
Result: [{&quot;_id&quot;:&quot;5a7b7df69d07887542605888&quot;,&quot;name&quot;:&quot;Hello!&quot;,&quot;__v&quot;:0}]
$</code></pre><p>At this point, you would try re-using the database connection using the same
global state trick that works in AWS Lambda and other cloud function providers.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> co = <span class="hljs-built_in">require</span>(<span class="hljs-string">'co'</span>);
<span class="hljs-keyword">const</span> mongodb = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>);

<span class="hljs-keyword">const</span> uri = <span class="hljs-string">'ATLAS_URI_HERE'</span>;

<span class="hljs-comment">// Other cloud providers would retain this, but not Google Cloud</span>
<span class="hljs-keyword">let</span> client = <span class="hljs-literal">null</span>;

exports.helloWorld = (req, res) =&gt; {
  co(<span class="hljs-function"><span class="hljs-keyword">function</span>*(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">const</span> reusedConnection = client != <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">if</span> (client == <span class="hljs-literal">null</span>) {
      client = <span class="hljs-keyword">yield</span> mongodb.MongoClient.connect(uri);   
    }

    <span class="hljs-keyword">const</span> docs = <span class="hljs-keyword">yield</span> client.db(<span class="hljs-string">'test'</span>).collection(<span class="hljs-string">'tests'</span>).find().toArray();
    res.send(<span class="hljs-string">'Result: '</span> + <span class="hljs-built_in">JSON</span>.stringify(docs) + <span class="hljs-string">', Reused: '</span> + reusedConnection);
  }).catch(error =&gt; {
    res.send(<span class="hljs-string">'Error: '</span> + error.toString());
  })
};</code></pre>
<p>Unfortunately, the global state trick doesn&#39;t seem to work in Google Cloud.</p>
<pre><code>$ curl https://us-central1-test21-201718.cloudfunctions.net/hello-world
Result: [{&quot;_id&quot;:&quot;5a7b7df69d07887542605888&quot;,&quot;name&quot;:&quot;Hello!&quot;,&quot;__v&quot;:0}], Reused: false
$
$ curl https://us-central1-test21-201718.cloudfunctions.net/hello-world
Result: [{&quot;_id&quot;:&quot;5a7b7df69d07887542605888&quot;,&quot;name&quot;:&quot;Hello!&quot;,&quot;__v&quot;:0}], Reused: false
$</code></pre><h2 id="moving-on">Moving On</h2>
<p>FaaS is a powerful paradigm, but purely stateless functions suffer from performance
limitations when dealing with databases because establishing a new database
connection is costly. Most cloud function providers have a mechanism for
retaining database connections between function calls, but apparently Google Cloud
Functions does not. This severely limits Google Cloud Functions&#39; ability to serve
as a replacement for a conventional web server.</p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/#{post.src.substr('./lib/posts/'.length)}">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname
}));</script><link rel="stylesheet" href="/style/inlinecpc.css"></body></html>