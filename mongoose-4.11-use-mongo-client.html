<!DOCTYPE html><html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>What's New in Mongoose 4.11: useMongoClient | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"><link href="/style/style.css" rel="stylesheet" type="text/css"><link href="/style/github.css" rel="stylesheet" type="text/css"><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="What's New in Mongoose 4.11: useMongoClient"><meta property="og:url" content="http://www.thecodebarbarian.com/mongoose-4.11-use-mongo-client"><meta property="og:image" content="http://i.imgur.com/3Ojk94g.jpg"><meta property="og:site_name" content="The Code Barbarian"><meta property="description" content="[Mongoose 4.11](https://github.com/Automattic/mongoose/blob/master/History.md#4110--2017-06-25) introduced an important new option to work around a major deprecation. The [`useMongoClient` option](http://mongoosejs.com/docs/connections.html#use-mongo-client) is the source of the ['`open()` is deprecated in mongoose' deprecation warning that has caused so much discussion](https://github.com/Automattic/mongoose/issues/5399). This option opts you in to using Mongoose 4.11's simplified initial connection logic and allows you to avoid getting a [deprecation warning from the underyling MongoDB driver](https://github.com/Automattic/mongoose/issues/5304)."><meta name="twitter:image" content="http://i.imgur.com/3Ojk94g.jpg"></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li><li><a href="/recommendations">recommendations</a></li></ul></div></div><div class="navbar" id="nav"><div class="container"><div class="navbar-header"><a class="navbar-brand big-brand" href="http://thecodebarbarian.com"><img class="logo" src="/images/Barbarian_Head.png"><span class="site-name">The Code Barbarian</span></a></div><div class="navbar-right collapse navbar-collapse" id="home-nav-mobile"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li><a href="/tag/vue.html">Vue</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div class="col-lg-3 col-lg-offset-9 right-bar" id="desktop-right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div></p></div></div></div></div></div><div class="container-fluid hidden-sm hidden-md hidden-lg" id="mobile-sharing-options"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a class="social" href="#disqus_thread"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div class="post-sharing-options hidden-xs pull-left" id="desktop-sharing-options"><ul class="list-unstyled"><li class="twitter-share"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">What's New in Mongoose 4.11: useMongoClient</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">July 14, 2017</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>

<div class="native-banner"></div>
</div><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CKYI5K3Y&placement=thecodebarbariancom" id="_carbonads_js"></script><div class="post-body-text-container"><p><a href="https://github.com/Automattic/mongoose/blob/master/History.md#4110--2017-06-25">Mongoose 4.11</a> introduced an important new option to work around a major deprecation. The <a href="http://mongoosejs.com/docs/connections.html#use-mongo-client"><code>useMongoClient</code> option</a> is the source of the <a href="https://github.com/Automattic/mongoose/issues/5399">&#39;<code>open()</code> is deprecated in mongoose&#39; deprecation warning that has caused so much discussion</a>. This option opts you in to using Mongoose 4.11&#39;s simplified initial connection logic and allows you to avoid getting a <a href="https://github.com/Automattic/mongoose/issues/5304">deprecation warning from the underyling MongoDB driver</a>.</p>
<h2 id="why-is-this-option-necessary">Why is This Option Necessary?</h2>
<p>Mongoose 4.10 users who used auth (which should be <a href="https://blog.shodan.io/its-the-data-stupid/">everyone that uses Mongoose in production, right?</a>) started seeing the following deprecation warning:</p>
<pre><code>Db.prototype.authenticate method will no longer be available in the next major release 3.x as MongoDB 3.6 will only allow auth against users in the admin db and will no longer allow multiple credentials on a socket. Please authenticate using MongoClient.connect with auth credentials.</code></pre><p>This warning comes from the <a href="https://www.npmjs.com/package/mongodb">MongoDB Node.js driver</a>. Currently, connecting and authenticating are distinct operations in MongoDB. You can connect to your database and then authenticate later, which is <a href="https://github.com/Automattic/mongoose/blob/c703010f2b42f7a124e64889111f8e767081f089/lib/connection.js#L690">what mongoose 4.x does by default</a>. You can even authenticate as multiple different users on the same connection.</p>
<p>As far as I understand, MongoDB is planning on removing this functionality in 3.6 and consolidating connecting and authenticating into one single operation. Keep in mind that I am <strong>not</strong> currently a MongoDB employee and do <strong>not</strong> speak for the company as a whole, my interpretation of this may not be entirely correct.</p>
<p>However, my understanding is that mongoose will <strong>not</strong> be able to authenticate against MongoDB 3.6 without the <code>useMongoClient</code> option. At the time of this writing, the release date for MongoDB 3.6 has not been announced yet. But I recommend you upgrade to mongoose 4.11 and start using <code>useMongoClient</code> as soon as possible, because to the best of my knowledge you will be able to use MongoDB 3.6 without it.</p>
<h2 id="using-usemongoclient">Using <code>useMongoClient</code></h2>
<p>First, it&#39;s important to note that <code>useMongoClient</code> only affects <strong>initial</strong> connection. Once you have successfully connected to MongoDB, your code should not have to do anything differently. If this is not the case, please <a href="https://github.com/Automattic/mongoose/issues">report a bug on the mongoose GitHub page</a>.</p>
<p>Secondly, as long as you&#39;re using mongoose 4.x and you&#39;re using MongoDB 3.4 or earlier, your existing connection code will continue to work. You will see the deprecation warning, but mongoose is committed to following <a href="http://semver.org/">semver</a>, so you can safely ignore this warning until mongoose 5.x and MongoDB 3.6 are released and you choose to upgrade.</p>
<p>The <code>useMongoClient</code> option is for <code>mongoose.connect()</code> and <code>mongoose.createConnection()</code>.
If you use <code>mongoose.connect()</code>, you don&#39;t have to change much:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

mongoose.Promise = global.Promise;

<span class="hljs-comment">// Connect to MongoDB on localhost:27017</span>
mongoose.connect(<span class="hljs-string">'mongodb://localhost:27017/test'</span>, { useMongoClient: <span class="hljs-literal">true</span> });

<span class="hljs-comment">// Create a model and insert a new doc</span>
<span class="hljs-keyword">const</span> Test = mongoose.model(<span class="hljs-string">'Test'</span>, <span class="hljs-keyword">new</span> mongoose.Schema({ name: <span class="hljs-built_in">String</span> }));
Test.create({ name: <span class="hljs-string">'Val'</span> }).then(doc =&gt; <span class="hljs-built_in">console</span>.log(doc));</code></pre>
<p>You can also use <a href="http://thecodebarbarian.com/80-20-guide-to-async-await-in-node.js">async/await</a>:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

mongoose.Promise = global.Promise;

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">// With `useMongoClient`, `mongoose.connect()` returns a thenable</span>
  <span class="hljs-keyword">await</span> mongoose.connect(<span class="hljs-string">'mongodb://localhost:27017/test'</span>, { useMongoClient: <span class="hljs-literal">true</span> });

  <span class="hljs-keyword">const</span> Test = mongoose.model(<span class="hljs-string">'Test'</span>, <span class="hljs-keyword">new</span> mongoose.Schema({ name: <span class="hljs-built_in">String</span> }));
  <span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">await</span> Test.create({ name: <span class="hljs-string">'Val'</span> });
  <span class="hljs-built_in">console</span>.log(doc);
}

run().catch(error =&gt; <span class="hljs-built_in">console</span>.error(error.stack));</code></pre>
<p>The <code>createConnection()</code> also works similarly. The difference is that, with mongoose &gt;= 4.11.2 (but <strong>not</strong> 4.11.0 or 4.11.1 because of a bug) you can start using the returned connection object. You can optionally <code>await</code> on the returned connection to wait for initial connection.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

mongoose.Promise = global.Promise;

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">// Can start using `conn` directly, or use `await mongoose.createConnection()`</span>
  <span class="hljs-comment">// to wait for initial connection to finish</span>
  <span class="hljs-keyword">const</span> conn = mongoose.createConnection(<span class="hljs-string">'mongodb://localhost:27017/test'</span>, {
    useMongoClient: <span class="hljs-literal">true</span>
  });

  <span class="hljs-keyword">const</span> Test = conn.model(<span class="hljs-string">'Test'</span>, <span class="hljs-keyword">new</span> mongoose.Schema({ name: <span class="hljs-built_in">String</span> }));
  <span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">await</span> Test.create({ name: <span class="hljs-string">'Val'</span> });
  <span class="hljs-built_in">console</span>.log(doc);
}

run().catch(error =&gt; <span class="hljs-built_in">console</span>.error(error.stack));</code></pre>
<p>If you use <code>open()</code> or <code>openSet()</code> directly, you should instead use <code>openUri()</code>:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

mongoose.Promise = global.Promise;

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-comment">// `open()` and `openSet()` are deprecated and will go away in mongoose 5.x</span>
  <span class="hljs-comment">// use `openUri()` instead</span>
  <span class="hljs-keyword">const</span> conn = <span class="hljs-keyword">await</span> mongoose.createConnection().openUri(<span class="hljs-string">'mongodb://localhost:27017/test'</span>);

  <span class="hljs-keyword">const</span> Test = conn.model(<span class="hljs-string">'Test'</span>, <span class="hljs-keyword">new</span> mongoose.Schema({ name: <span class="hljs-built_in">String</span> }));
  <span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">await</span> Test.create({ name: <span class="hljs-string">'Val'</span> });
  <span class="hljs-built_in">console</span>.log(doc);
}

run().catch(error =&gt; <span class="hljs-built_in">console</span>.error(error.stack));</code></pre>
<h2 id="moving-on">Moving On</h2>
<p>The <code>useMongoClient</code> option is a big change, but a necessary one for mongoose to support MongoDB 3.6. MongoDB 3.6 has no scheduled release date yet, so switching is not pressing. However, I recommend you start using <code>useMongoClient</code> as soon as possible and report any issues that come up on <a href="https://github.com/Automattic/mongoose/issues">mongoose&#39;s GitHub issues page</a>.</p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/#{post.src.substr('./lib/posts/'.length)}">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname
}));</script><link rel="stylesheet" href="/style/inlinecpc.css"></body></html>