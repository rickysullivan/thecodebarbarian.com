<!DOCTYPE html><html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>What's New in Mongoose 7.1: BigInt Support and createCollections() | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"><link href="/style/style.css" rel="stylesheet" type="text/css"><link href="/style/github.css" rel="stylesheet" type="text/css"><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="What's New in Mongoose 7.1: BigInt Support and createCollections()"><meta property="og:url" content="http://www.thecodebarbarian.com/whats-new-in-mongoose-7-1-bigint-support-createcollections"><meta property="og:image" content="https://images.unsplash.com/photo-1514214246283-d427a95c5d2f?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=710&amp;q=80"><meta property="og:site_name" content="The Code Barbarian"><meta property="description" content="Mongoose 7.1 was released on April 27, 2023. Here's more info on a couple of new features in 7.1."><meta name="twitter:image" content="https://images.unsplash.com/photo-1514214246283-d427a95c5d2f?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=710&amp;q=80"></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li><li><a href="/recommendations">recommendations</a></li></ul></div></div><div class="navbar" id="nav"><div class="container"><div class="navbar-header"><a class="navbar-brand big-brand" href="http://thecodebarbarian.com"><img class="logo" src="/images/Barbarian_Head.png"><span class="site-name">The Code Barbarian</span></a></div><div class="navbar-right collapse navbar-collapse" id="home-nav-mobile"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li><a href="/tag/vue.html">Vue</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div class="col-lg-3 col-lg-offset-9 right-bar" id="desktop-right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div></p></div></div></div></div></div><div class="container-fluid hidden-sm hidden-md hidden-lg" id="mobile-sharing-options"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a class="social" href="#disqus_thread"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div class="post-sharing-options hidden-xs pull-left" id="desktop-sharing-options"><ul class="list-unstyled"><li class="twitter-share"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">What's New in Mongoose 7.1: BigInt Support and createCollections()</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">April 28, 2023</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>

<div class="native-banner"></div>
</div><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CKYI5K3Y&placement=thecodebarbariancom" id="_carbonads_js"></script><div class="post-body-text-container"><p><a href="https://github.com/Automattic/mongoose/releases/tag/7.1.0">Mongoose 7.1.0 was released on April 27, 2023</a> and includes a couple of interesting new features.
The most interesting new feature is <a href="/an-overview-of-bigint-in-node-js.html">BigInt</a> support, which 
In this blog post, I&#39;ll also cover the new <a href="https://mongoosejs.com/docs/api/connection.html#Connection.prototype.createCollections()"><code>createCollections()</code> function</a>.</p>
<h2 id="working-with-bigints-in-mongoose">Working with BigInts in Mongoose</h2>
<p>Mongoose 7.1 introduces a new <a href="https://mongoosejs.com/docs/schematypes.html#bigint">BigInt SchemaType</a>, so you can define paths as BigInts in your schema.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> schema = <span class="hljs-keyword">new</span> Schema({
  answer: BigInt
});
<span class="hljs-keyword">const</span> Question = mongoose.model(<span class="hljs-string">'Question'</span>, schema);

<span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">new</span> Question({ answer: <span class="hljs-number">42</span>n });
doc.answer; <span class="hljs-comment">// 42n</span>
<span class="hljs-keyword">typeof</span> doc.answer; <span class="hljs-comment">// 'bigint'</span></code></pre>
<p>Mongoose handles basic casting for BigInts, including converting strings and numbers to BigInts.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> doc1 = <span class="hljs-keyword">new</span> Question({ answer: <span class="hljs-number">42</span> });
doc1.answer; <span class="hljs-comment">// 42n</span>

<span class="hljs-keyword">const</span> doc2 = <span class="hljs-keyword">new</span> Question({ answer: <span class="hljs-string">'42'</span> });
doc2.answer; <span class="hljs-comment">// 42n</span>

<span class="hljs-keyword">const</span> doc3 = <span class="hljs-keyword">new</span> Question({ answer: <span class="hljs-string">'foobar'</span> });
<span class="hljs-keyword">await</span> doc3.validate(); <span class="hljs-comment">// Throws a CastError</span></code></pre>
<p>BigInts in JavaScript theoretically support arbitrary large integers.
But, with Mongoose, there is a limitation: the MongoDB Node.js driver stores BigInts as 64-bit integers in MongoDB.
So, while you can represent a number larger than <code>2^63 - 1</code> as a BigInt in JavaScript, MongoDB will store that number as 0.</p>
<pre><code class="language-javascript"><span class="hljs-comment">// Stores answer as `answer: new Long("9223372036854775807")`</span>
<span class="hljs-keyword">await</span> Question.create({ answer: <span class="hljs-number">2</span>n**<span class="hljs-number">63</span>n - <span class="hljs-number">1</span>n });

<span class="hljs-comment">// Stores answer as 0</span>
<span class="hljs-keyword">await</span> Question.create({ answer: <span class="hljs-number">2</span>n**<span class="hljs-number">64</span>n });</code></pre>
<p>To work around this, we recommend adding a custom validator to BigInts:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> schema = <span class="hljs-keyword">new</span> Schema({
  answer: {
    type: BigInt,
    validate: v =&gt; v == <span class="hljs-literal">null</span> || (v &lt; <span class="hljs-number">2</span>n**<span class="hljs-number">63</span>n &amp;&amp; v &gt; (<span class="hljs-number">-2</span>n)**<span class="hljs-number">63</span>n)
  }
});

<span class="hljs-comment">// With the above schema, the following code throws this error:</span>
<span class="hljs-comment">// "Question validation failed: answer: Validator failed for path `answer`</span>
<span class="hljs-comment">// with value `18446744073709551616`"</span>
<span class="hljs-keyword">await</span> Question.create({ answer: <span class="hljs-number">2</span>n**<span class="hljs-number">64</span>n });</code></pre>
<p>While BigInts are practically limited in size with Mongoose, they do still offer support for a wider range of integers than plain old JavaScript numbers.
Remember that, with JavaScript numbers, the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/MAX_SAFE_INTEGER">max safe integer is <code>2**53 - 1</code></a>.
With Mongoose, you can store integers up to <code>2**63 - 1</code> in MongoDB, and work with even larger integers in memory.</p>
<h2 id="the-createcollections-function">The <code>createCollections()</code> Function</h2>
<p>Mongoose connections now have a <a href="https://mongoosejs.com/docs/api/connection.html#Connection.prototype.createCollections()"><code>createCollections()</code> function</a> that executes <a href="https://mongoosejs.com/docs/api/model.html#Model.createCollection()"><code>createCollection()</code></a> for every model currently registered on the connection.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> BlogPost = mongoose.model(<span class="hljs-string">'BlogPost'</span>, blogPostSchema);
<span class="hljs-keyword">const</span> User = mongoose.model(<span class="hljs-string">'User'</span>, userSchema);

<span class="hljs-comment">// Calls `BlogPost.createCollection()`, `User.createCollection()`, etc.</span>
<span class="hljs-keyword">await</span> mongoose.connection.createCollections();</code></pre>
<p>Most of the time, you don&#39;t need to explicitly create collections in MongoDB.
If you try to insert a document into a non-existent collection, MongoDB will first create the collection for you.
However, there are a number of newer MongoDB features that require you to be more careful about creating collections:</p>
<ol>
<li><a href="/a-node-js-perspective-on-mongodb-4-transactions.html">Transactions</a>. MongoDB will throw an error if you try to write to a non-existent collection in a transaction.</li>
<li><a href="/a-nodejs-perspective-on-mongodb-34-collations">Collations</a>. You can&#39;t modify a collection&#39;s default collation after you&#39;ve created the collection.</li>
<li>Timeseries collections and capped collections. You can&#39;t change a collection&#39;s type once it has been created.</li>
</ol>
<p>Mongoose lets you configure some collection options, like <code>collation</code>, <code>timeseries</code>, etc. in your schema.
For example, the following is how you can define a capped collection in a Mongoose schema.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> schema = <span class="hljs-keyword">new</span> Schema({ name: <span class="hljs-built_in">String</span> }, { capped: { size: <span class="hljs-number">1024</span> } });
<span class="hljs-keyword">const</span> Test = mongoose.model(<span class="hljs-string">'Test'</span>, schema);</code></pre>
<p>Unless you set the <a href="https://mongoosejs.com/docs/guide.html#autoCreate">autoCreate option</a>, Mongoose won&#39;t automatically create the capped collection for you.
The <code>createCollections()</code> function gives you a neat alternative to <code>autoCreate</code> that lets you create all your collections, using the options defined in your schemas, with a single command.
This is especially convenient for testing purposes, where you want to wait for Mongoose to finish creating collections before using them.</p>
<p>Keep in mind that <code>createCollections()</code> currently will <strong>not</strong> throw an error if the collection already exists, even if the collection has different options.</p>
<pre><code class="language-javascript"><span class="hljs-comment">// Create a non-capped collection</span>
<span class="hljs-keyword">let</span> schema = <span class="hljs-keyword">new</span> Schema({ name: <span class="hljs-built_in">String</span> });
<span class="hljs-keyword">let</span> Test = mongoose.model(<span class="hljs-string">'Test'</span>, schema);
<span class="hljs-keyword">await</span> Test.createCollection();

schema = <span class="hljs-keyword">new</span> Schema({ name: <span class="hljs-built_in">String</span> }, { capped: { size: <span class="hljs-number">1024</span> } });
mongoose.deleteModel(<span class="hljs-string">'Test'</span>);
<span class="hljs-keyword">let</span> Test = mongoose.model(<span class="hljs-string">'Test'</span>, schema);
<span class="hljs-comment">// Does **not** throw an error, even though it couldn't create a capped collection</span>
<span class="hljs-comment">// because a non-capped collection with the same name already exists.</span>
<span class="hljs-keyword">await</span> Test.createCollection();</code></pre>
<p>For tests, I recommend calling <code>dropDatabase()</code> before calling <code>createCollections()</code> to ensure that your collections are correctly configured.
We plan on adding support for diffing collection options in the future, so Mongoose can tell you if the underlying collection is equivalent to your schema options or not.
Mongoose may even be able to use <a href="https://www.mongodb.com/docs/manual/reference/command/collMod/">collMod</a> to automatically update some schema options.</p>
<h2 id="moving-on">Moving On</h2>
<p>Mongoose 7.1 is a relatively small release, with just 5 new features. BigInt support and <code>createCollections()</code> are the most noteworthy, but Mongoose 7.1 also expands UUID support and adds a new <code>isPathSelectedInclusive()</code> helper to queries for plugins.
Make sure you upgrade to take advantage of the new features!</p>
<p><em>Want to become your team&#39;s MongoDB expert? &quot;Mastering Mongoose&quot; distills 10 years of hard-earned lessons building Mongoose apps at scale into 153 pages. That means you can learn what you need to know to build production-ready full-stack apps with Node.js and MongoDB in a few days. <a href="https://masteringjs.io/ebooks/mastering-mongoose">Get your copy</a>!</em></p>
<a href="https://masteringjs.io/ebooks/mastering-mongoose" class="async-await-banner">
  <img src="https://masteringjs.io/ebooks/mastering-mongoose-horizontal.png">
</a></div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/#{post.src.substr('./lib/posts/'.length)}">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname
}));</script><link rel="stylesheet" href="/style/inlinecpc.css"></body></html>