<!DOCTYPE html><html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>Introducing Mongoose 7 | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"><link href="/style/style.css" rel="stylesheet" type="text/css"><link href="/style/github.css" rel="stylesheet" type="text/css"><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="Introducing Mongoose 7"><meta property="og:url" content="http://www.thecodebarbarian.com/introducing-mongoose-7"><meta property="og:image" content="https://images.unsplash.com/photo-1533106497176-45ae19e68ba2?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=710&amp;q=80"><meta property="og:site_name" content="The Code Barbarian"><meta property="description" content="Mongoose 7 was released in February 2023. Here's what you need to know about what changed in Mongoose 7."><meta name="twitter:image" content="https://images.unsplash.com/photo-1533106497176-45ae19e68ba2?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=710&amp;q=80"></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li><li><a href="/recommendations">recommendations</a></li></ul></div></div><div class="navbar" id="nav"><div class="container"><div class="navbar-header"><a class="navbar-brand big-brand" href="http://thecodebarbarian.com"><img class="logo" src="/images/Barbarian_Head.png"><span class="site-name">The Code Barbarian</span></a></div><div class="navbar-right collapse navbar-collapse" id="home-nav-mobile"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li><a href="/tag/vue.html">Vue</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div class="col-lg-3 col-lg-offset-9 right-bar" id="desktop-right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div></p></div></div></div></div></div><div class="container-fluid hidden-sm hidden-md hidden-lg" id="mobile-sharing-options"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a class="social" href="#disqus_thread"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div class="post-sharing-options hidden-xs pull-left" id="desktop-sharing-options"><ul class="list-unstyled"><li class="twitter-share"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">Introducing Mongoose 7</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">March 14, 2023</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>

<div class="native-banner"></div>
</div><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CKYI5K3Y&placement=thecodebarbariancom" id="_carbonads_js"></script><div class="post-body-text-container"><p><a href="https://github.com/Automattic/mongoose/releases/tag/7.0.0">Mongoose 7</a> was released on February 27, 2023.
This major release is relatively small compared to <a href="/whats-new-in-mongoose-6-sanitizefilter.html">Mongoose 6</a>, with only 14 backwards breaking changes.
The most significant backwards breaking changes are dropping support for callbacks and upgrading to <a href="https://github.com/mongodb/node-mongodb-native/blob/main/HISTORY.md#500-2023-01-31">MongoDB Node.js driver 5.x</a>, but there are a few smaller changes that are worth highlighting.</p>
<p>Now that Mongoose 7 is out, we plan on continuing to support Mongoose 6 and backport bug fixes as necessary.
We will <strong>not</strong> backport any new features to Mongoose 6, we&#39;re only shipping patch releases to Mongoose 6 only going forward.
As for Mongoose 5, we will continue to merge PRs that are specific to Mongoose 5, but we will <strong>not</strong> backport any features or bug fixes to Mongoose 5 unless specifically requested.</p>
<p>Without further ado, here&#39;s some of the highlights from Mongoose 7.
You can find the full <a href="https://mongoosejs.com/docs/migrating_to_7.html">migration guide</a> on the Mongoose docs.</p>
<h2 id="no-more-callbacks">No More Callbacks</h2>
<p>When Mongoose was first released in 2010, <a href="https://masteringjs.io/tutorials/fundamentals/callbacks">callbacks</a> were the preferred concurrency primitive in Node.js.
Mongoose code looked like this:</p>
<pre><code class="language-javacript">Model.findOne({ _id: _id }, function(err, doc) {
  if (err) {
    return res.status(404).json({ message: &#39;Not Found&#39; });
  }
  res.json({ doc: doc });
});</code></pre>
<p>However, <a href="/the-80-20-guide-to-promises-in-node-js.html">promises</a> in 2015 and <a href="/async-await-error-handling-in-javascript.html">async/await</a> in 2017 offered numerous advantages over callbacks.
Pretty soon, there was a whole generation of JavaScript developers that had never used callbacks.</p>
<ul>
<li>Promises and async/await are standardized, callbacks are not</li>
<li>Promises and async/await offer better error handling - what happens if your callback function throws an error?</li>
</ul>
<p>One async/await feature that we&#39;re particularly excited about for Mongoose is <a href="/async-stack-traces-in-node-js-12.html">async stack traces</a>.
Without async stack traces, Node&#39;s event loop means that stack traces often contain just Node and MongoDB internals, with no reference to the point in your code that caused the error.
As Mongoose 7 evolves, you should see better and better stack traces.
For example, below is the stack trace if <code>mongoose.connect()</code> fails because the MongoDB server is down.</p>
<pre><code>at _handleConnectionErrors (/node_modules/mongoose/lib/connection.js:755:11)
at NativeConnection.openUri (/node_modules/mongoose/lib/connection.js:730:11)
at async run (/app.js:8:3)</code></pre><pre><code class="language-javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

run().catch(err =&gt; <span class="hljs-built_in">console</span>.log(err));

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">await</span> mongoose.connect(<span class="hljs-string">'mongodb://127.0.0.1/mongoose_test'</span>);
}</code></pre>
<p>Mongoose isn&#39;t fully compatible with async stack traces yet - for async stack traces, you need to use async functions all the way through.
And Mongoose still has some callback-based code internally.
But we&#39;re continuing to work on improving Mongoose&#39;s async stack trace support.</p>
<h2 id="strictquery-is-false-by-default-again"><code>strictQuery</code> is <code>false</code> By Default Again</h2>
<p>In Mongoose 6, we <a href="https://mongoosejs.com/docs/migrating_to_6.html#strictquery-is-removed-and-replaced-by-strict">tried to remove <code>strictQuery</code></a> and ended up having to bring <code>strictQuery</code> back with several workarounds to minimize the impact of this breaking change.
The <code>strictQuery</code> option controls how Mongoose handles querying by fields that aren&#39;t in your schema.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> TestModel = mongoose.model(<span class="hljs-string">'Test'</span>, mongoose.Schema({ name: <span class="hljs-built_in">String</span> }));

<span class="hljs-comment">// `otherProp` is not in the schema. What to do?</span>
<span class="hljs-keyword">await</span> TestModel.find({ otherProp: <span class="hljs-string">'test'</span> });</code></pre>
<p>In Mongoose 6, with <code>strictQuery = true</code> by default, Mongoose would strip out <code>otherProp</code> from the query filter, making the above query equivalent to <code>await TestModel.find({})</code>.
That would return <em>all</em> documents in <code>TestModel</code>&#39;s collection.
Filtering out unknown properties was problematic for many reasons, most notably because typo-ing a property name would lead to returning all documents, leading to potential performance degradation and security issues.</p>
<p>In Mongoose 7, <code>strictQuery</code> is false by default, exactly as it was in Mongoose 5.
With <code>strictQuery = false</code>, Mongoose will <strong>not</strong> strip out unknown fields from the query filter.
So <code>TestModel.find({ otherProp: &#39;test&#39; })</code> will find all documents where <code>otherProp</code> is equal to &#39;test&#39;.</p>
<h2 id="orfail-and-updateone"><code>orFail()</code> and <code>updateOne()</code></h2>
<p>The <a href="/whats-new-in-mongoose-53-orfail-and-global-toobject.html"><code>orFail()</code> function</a> is a neat tool for triggering an error if a query doesn&#39;t find any documents.
The <code>orFail()</code> function is often used with <code>findOne()</code> to throw an HTTP 404 error if no document is found.</p>
<pre><code class="language-javascript"><span class="hljs-comment">// Throw an error if no user has an `_id` that matches `req.query._id`</span>
<span class="hljs-keyword">await</span> User.findById(req.query._id).setOptions({ sanitizeFilter: <span class="hljs-literal">true</span> }).orFail();</code></pre>
<p>The <code>orFail()</code> function is also convenient for TypeScript, because it makes the query result non-nullable.</p>
<pre><code class="language-ts">// `user1` has type `User | null`
const user1 = await User.findById(req.query._id);

// `user2` has type `User`
const user2 = await User.findById(req.query._id).orFail();</code></pre>
<p>In Mongoose 5 and Mongoose 6, using <code>updateOne().orFail()</code> would throw an error if no document was <em>modified</em>.
Unfortunately, that means <code>updateOne().orFail()</code> would error out if a document was found, but none of the updates made any changes to the document.
For example, the following code would throw in Mongoose 6, but does not throw in Mongoose 7.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">await</span> User.create({ name: <span class="hljs-string">'John Smith'</span> });

<span class="hljs-comment">// In Mongoose 6, throws because `name` is already 'John Smith'.</span>
<span class="hljs-comment">// In Mongoose 7, succeeds, because there is a doc that matches `{ _id: doc._id }`</span>
<span class="hljs-keyword">await</span> User.updateOne({ _id: doc._id }, { name: <span class="hljs-string">'John Smith'</span> }).orFail();</code></pre>
<p>In Mongoose 7, <code>updateOne().orFail()</code>, <code>updateMany().orFail()</code>, and <code>replaceOne().orFail()</code> only throw if no document matched the filter.
If a document was found but not modified, <code>orFail()</code> will <strong>not</strong> throw.</p>
<h2 id="copying-schema-options-on-add">Copying Schema Options on <code>add()</code></h2>
<p>Mongoose 7 now copies schema options when you <code>add()</code> a schema or define a schema using an array of schemas.
In Mongoose 6, <code>add()</code>-ing a schema only copied schema paths, not options.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> baseSchema = <span class="hljs-keyword">new</span> Schema(
  { createdAt: <span class="hljs-built_in">Number</span>, updatedAt: <span class="hljs-built_in">Number</span> },
  {
    timestamps: <span class="hljs-literal">true</span>,
    toJSON: { virtuals: <span class="hljs-literal">true</span> },
    toObject: { virtuals: <span class="hljs-literal">true</span> }
  }
);

<span class="hljs-comment">// Create a new schema with the same paths and options as `baseSchema`,</span>
<span class="hljs-comment">// plus a few more.</span>
<span class="hljs-comment">// In Mongoose 6, this wouldn't copy baseSchema's options.</span>
<span class="hljs-keyword">const</span> userSchema = <span class="hljs-keyword">new</span> Schema([
  baseSchema,
  {
    name: <span class="hljs-built_in">String</span>
  }
]);

userSchema.path(<span class="hljs-string">'createdAt'</span>); <span class="hljs-comment">// Number</span>
userSchema.options.timestamps; <span class="hljs-comment">// true</span>
userSchema.options.toJSON; <span class="hljs-comment">// { virtuals: true }</span>
userSchema.options.toObject; <span class="hljs-comment">// { virtuals: true }</span>

<span class="hljs-comment">// Also works using `Schema.prototype.add()`</span>
<span class="hljs-keyword">const</span> productSchema = <span class="hljs-keyword">new</span> Schema(
  { name: <span class="hljs-built_in">String</span> },
  <span class="hljs-comment">// `add()` copies options, _unless_ there's already a user-specified option</span>
  { toJSON: { getters: <span class="hljs-literal">true</span> } }
);
productSchema.add(baseSchema);

productSchema.path(<span class="hljs-string">'createdAt'</span>); <span class="hljs-comment">// Number</span>
productSchema.options.timestamps; <span class="hljs-comment">// true</span>
productSchema.options.toObject; <span class="hljs-comment">// { virtuals: true }</span>
<span class="hljs-comment">// Uses productSchema's `toJSON` option</span>
productSchema.options.toJSON; <span class="hljs-comment">// { getters: true }</span></code></pre>
<p>This feature is great for schema composition.
Before, you had to use either Mongoose&#39;s <a href="https://mongoosejs.com/docs/api/mongoose.html#mongoose_Mongoose-set">global configuration</a> or class inheritance to define default options for your schema.
Now, you can use a mixin-like pattern by passing an array of schemas and schema definition objects to <code>new Schema()</code>.</p>
<h2 id="moving-on">Moving On</h2>
<p>These are just a few of the improvements we&#39;ve made in Mongoose 7.
Check out the <a href="https://mongoosejs.com/docs/migrating_to_7.html">migration guide</a> for a full list of all the potentially breaking changes.
Please upgrade and open any issues you find on <a href="https://github.com/Automattic/mongoose/issues/new">Mongoose&#39;s GitHub page</a>!</p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/#{post.src.substr('./lib/posts/'.length)}">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname
}));</script><link rel="stylesheet" href="/style/inlinecpc.css"></body></html>