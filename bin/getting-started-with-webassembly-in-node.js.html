<!DOCTYPE html><html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>Getting Started With WebAssembly in Node.js | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"><link href="/style/style.css" rel="stylesheet" type="text/css"><link href="/style/github.css" rel="stylesheet" type="text/css"><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="Getting Started With WebAssembly in Node.js"><meta property="og:url" content="http://www.thecodebarbarian.com/getting-started-with-webassembly-in-node.js"><meta property="og:image" content="http://thecodebarbarian.com/images/gear.jpg"><meta property="og:site_name" content="The Code Barbarian"><meta property="description" content="An introduction to writing, compiling, and using webassembly in Node.js. Updated for 2020."><meta name="twitter:image" content="http://thecodebarbarian.com/images/gear.jpg"></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li><li><a href="/recommendations">recommendations</a></li></ul></div></div><div class="navbar" id="nav"><div class="container"><div class="navbar-header"><a class="navbar-brand big-brand" href="http://thecodebarbarian.com"><img class="logo" src="/images/Barbarian_Head.png"><span class="site-name">The Code Barbarian</span></a></div><div class="navbar-right collapse navbar-collapse" id="home-nav-mobile"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li><a href="/tag/vue.html">Vue</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div class="col-lg-3 col-lg-offset-9 right-bar" id="desktop-right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div></p></div></div></div></div></div><div class="container-fluid hidden-sm hidden-md hidden-lg" id="mobile-sharing-options"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a class="social" href="#disqus_thread"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div class="post-sharing-options hidden-xs pull-left" id="desktop-sharing-options"><ul class="list-unstyled"><li class="twitter-share"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">Getting Started With WebAssembly in Node.js</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">February 28, 2017</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>

<div class="native-banner"></div>
</div><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CVAIKKQM&placement=carbonadsnet" id="_carbonads_js"></script><div class="post-body-text-container"><p><a href="http://webassembly.org/">WebAssembly</a> is an exciting new language that many JavaScript engines have added support for. WebAssembly promises to make it much easier to compile languages like C and C++ to something that runs in the browser. However, I&#39;m most excited about the ability to write optimized custom arithmetic and buffer manipulations, like, say, <a href="http://thecodebarbarian.com/a-nodejs-perspective-on-mongodb-34-decimal.html">fast decimal floating point arithmetic in JavaScript</a> without having to <a href="https://mail.mozilla.org/pipermail/es-discuss/2008-February/005446.html">wait for TC39 to get around to it</a>. In this article, I&#39;ll show you how to get a couple rudimentary WebAssembly examples running in Node.js, and run a couple trivial benchmarks to show the performance impact.</p>
<p>Note that the code in this article is intended to be run with Node.js 12.14.0.</p>
<h2 id="what-is-webassembly-anyway">What is WebAssembly Anyway?</h2>
<p>Node.js 12 has a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly">global <code>WebAssembly</code> object</a> which has several helper functions for creating WebAssembly <em>modules</em>. For the purposes of this article, a WebAssembly module is just a collection of functions written in WebAssembly.</p>
<pre><code>$ ~/Workspace/libs/node-v12.14.0-darwin-x64/bin/node 
Welcome to Node.js v12.14.0.
Type &quot;.help&quot; for more information.
&gt; WebAssembly
Object [WebAssembly] {
  compile: [Function: compile],
  validate: [Function: validate],
  instantiate: [Function: instantiate]
}
&gt; </code></pre><p>To create a WebAssembly module, you need to call <code>WebAssembly.instantiate()</code> with a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Uint8Array">Uint8Array</a> that represents the module. Below is an example of instantiating an empty WebAssembly module.</p>
<pre><code>$ ~/Workspace/libs/node-v12.14.0-darwin-x64/bin/node
&gt; WebAssembly.instantiate(new Uint8Array([0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00]));
Promise { &lt;pending&gt; }
&gt;</code></pre><p>So at the basic level, creating a WebAssembly module consists of putting the correct hex digits into the <code>instantiate()</code> function. What do these hex numbers mean? These hex numbers are the <a href="http://webassembly.org/docs/binary-encoding/#module-structure">preamble</a> that every <code>.wasm</code> file starts with (<code>.wasm</code> is the canonical extension for WebAssembly files). Every WebAssembly file must have these bytes, so this is the minimum viable WebAssembly module.</p>
<h2 id="adding-two-numbers">Adding Two Numbers</h2>
<p>Thankfully, you don&#39;t have to write the bytes yourself. There&#39;s plenty of compilers out there for compiling C, C++, and even <a href="https://github.com/brson/mir2wasm">Rust</a> to WebAssembly. There&#39;s also an <a href="https://en.wikipedia.org/wiki/WebAssembly#Representation">intermediate format</a> called &quot;WebAssembly AST&quot;, or &quot;wast&quot; for short. Here&#39;s what a function that returns the sum of its 2 parameters looks like in wast:</p>
<pre><code>(module
  (func (export &quot;addTwo&quot;) (param i32 i32) (result i32)
    local.get 0
    local.get 1
    i32.add))</code></pre><p>You can use <a href="https://webassembly.github.io/wabt/demo/wat2wasm/">this online tool</a> to compile wast code down into the <code>wasm</code> binary, or you can just download the <a href="http://thecodebarbarian.com/sample/20170228/addTwo.wasm">compiled <code>.wasm</code> from me</a>.</p>
<p>Next, how do you use a <code>.wasm</code> file in Node.js? In order to use the <code>.wasm</code>, you need to load the file and convert the <a href="https://nodejs.org/api/buffer.html">Node.js buffer</a> that node&#39;s <code>fs</code> library returns into an Uint8Array.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> buf = fs.readFileSync(<span class="hljs-string">'./addTwo.wasm'</span>);
<span class="hljs-keyword">const</span> lib = <span class="hljs-keyword">await</span> WebAssembly.instantiate(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(buf)).
  then(res =&gt; res.instance.exports);

<span class="hljs-built_in">console</span>.log(lib.addTwo(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)); <span class="hljs-comment">// Prints '4'</span>
<span class="hljs-built_in">console</span>.log(lib.addTwo.toString()); <span class="hljs-comment">// Prints 'function addTwo() { [native code] }'</span></code></pre>
<p>How fast is <code>addTwo</code> in WebAssembly versus a plain old JavaScript implementation? Here&#39;s a trivial benchmark:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> buf = fs.readFileSync(<span class="hljs-string">'./addTwo.wasm'</span>);
<span class="hljs-keyword">const</span> lib = <span class="hljs-keyword">await</span> WebAssembly.instantiate(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(buf)).
  then(res =&gt; res.instance.exports);

<span class="hljs-keyword">const</span> Benchmark = <span class="hljs-built_in">require</span>(<span class="hljs-string">'benchmark'</span>);

<span class="hljs-keyword">const</span> suite = <span class="hljs-keyword">new</span> Benchmark.Suite;

suite.
  add(<span class="hljs-string">'wasm'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    lib.addTwo(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>);
  }).
  add(<span class="hljs-string">'js'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    addTwo(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>);
  }).
  on(<span class="hljs-string">'cycle'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">String</span>(event.target));
  }).
  on(<span class="hljs-string">'complete'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Fastest is '</span> + <span class="hljs-keyword">this</span>.filter(<span class="hljs-string">'fastest'</span>).map(<span class="hljs-string">'name'</span>));
  }).
  run();

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addTwo</span>(<span class="hljs-params">a, b</span>) </span>{
  <span class="hljs-keyword">return</span> a + b;
}</code></pre>
<pre><code>$ ~/Workspace/libs/node-v12.14.0-darwin-x64/bin/node ./test
wasm x 91,797,305 ops/sec ±1.26% (88 runs sampled)
js x 763,373,634 ops/sec ±2.28% (89 runs sampled)
Fastest is js
$ </code></pre><h2 id="factorial">Factorial</h2>
<p>WebAssembly doesn&#39;t have any performance benefit over plain old JS in the above example. Let&#39;s do something a little more complex: computing factorials recursively. Here&#39;s a <code>.wast</code> file that exposes a <code>fac()</code> function which computes factorial recursively.</p>
<pre><code>(module
  (func $_factorial (param i32) (result i32)
    (if (i32.lt_s (get_local 0) (i32.const 1))
      (then (return (i32.const 1)))
      (else
          (return (i32.mul (get_local 0) (call $_factorial (i32.sub (get_local 0) (i32.const 1))))))  
      )
    (return (i32.const 1))
  )
  (func (export &quot;factorial&quot;) (param i32) (result i32)
    (return (call $_factorial (get_local 0)))
  ))</code></pre><p>You can use <a href="https://webassembly.github.io/wabt/demo/wat2wasm/">this tool</a> to compile the <code>.wasm</code> or just <a href="http://thecodebarbarian.com/sample/20170228/factorial.wasm">download it here</a>.</p>
<p>Below is another trivial benchmark comparing computing <code>100!</code> with WebAssembly versus with JavaScript:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);
<span class="hljs-keyword">const</span> buf = fs.readFileSync(<span class="hljs-string">'./factorial.wasm'</span>);
<span class="hljs-keyword">const</span> lib = <span class="hljs-keyword">await</span> WebAssembly.instantiate(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(buf)).
  then(res =&gt; res.instance.exports);

<span class="hljs-keyword">const</span> Benchmark = <span class="hljs-built_in">require</span>(<span class="hljs-string">'benchmark'</span>);

<span class="hljs-keyword">const</span> suite = <span class="hljs-keyword">new</span> Benchmark.Suite;

suite.
  add(<span class="hljs-string">'wasm'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    lib.factorial(<span class="hljs-number">100</span>);
  }).
  add(<span class="hljs-string">'js'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    fac(<span class="hljs-number">100</span>);
  }).
  on(<span class="hljs-string">'cycle'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">String</span>(event.target));
  }).
  on(<span class="hljs-string">'complete'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Fastest is '</span> + <span class="hljs-keyword">this</span>.filter(<span class="hljs-string">'fastest'</span>).map(<span class="hljs-string">'name'</span>));
  }).
  run();

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fac</span>(<span class="hljs-params">n</span>) </span>{
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
  }
  <span class="hljs-comment">// `x | 0` rounds down, so `2.0001 | 0 === 2`. This helps deal with floating point precision issues like `0.1 + 0.2 !== 0.3`</span>
  <span class="hljs-keyword">return</span> (n * fac(n - <span class="hljs-number">1</span>)) | <span class="hljs-number">0</span>;
}</code></pre>
<pre><code>$ ~/Workspace/libs/node-v12.14.0-darwin-x64/bin/node ./test
wasm x 2,214,005 ops/sec ±5.45% (84 runs sampled)
js x 1,019,134 ops/sec ±3.60% (84 runs sampled)
Fastest is wasm
$</code></pre><h2 id="moving-on">Moving On</h2>
<p>In these rudimentary examples, WebAssembly shows promise in terms of allowing you to really optimize JS code. My benchmarks are quite rudimentary and WebAssembly is still unstable and not well adopted, so don&#39;t rush to try to write your next web app in wast. However, now&#39;s the time to play with WebAssembly, especially since it is available in Node.js.</p>
<p><em>I wrote this article (and many others) after a dose of <a href="https://www.amazon.com/gp/product/B00GXPS4Q8/ref=as_li_tl?ie=UTF8&amp;camp=1789&amp;creative=9325&amp;creativeASIN=B00GXPS4Q8&amp;linkCode=as2&amp;tag=codebarbarian-20&amp;linkId=e3467c80c382d0385811038575986e25">Ciltep</a> (<a href="https://www.amazon.com/Ciltep-Nootropic-Stack-Performance-Motivation/dp/B00GXPS4Q8/ref=sr_1_1_a_it?ie=UTF8&amp;qid=1488867312&amp;sr=8-1&amp;keywords=ciltep">non-affiliate link here</a>). Ciltep helps you stay focused and learn fast, without jitters or crashes. Give it a shot before you take a deep dive into WebAssembly.</em></p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/#{post.src.substr('./lib/posts/'.length)}">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname
}));</script><link rel="stylesheet" href="/style/inlinecpc.css"></body></html>