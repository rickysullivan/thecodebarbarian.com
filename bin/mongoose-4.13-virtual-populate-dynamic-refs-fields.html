<!DOCTYPE html><html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>What's New In Mongoose 4.13: Dynamic Refs and Fields for Virtual Populate | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"><link href="/style/style.css" rel="stylesheet" type="text/css"><link href="/style/github.css" rel="stylesheet" type="text/css"><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="What's New In Mongoose 4.13: Dynamic Refs and Fields for Virtual Populate"><meta property="og:url" content="http://www.thecodebarbarian.com/mongoose-4.13-virtual-populate-dynamic-refs-fields"><meta property="og:image" content="https://i.imgur.com/CSVk0mm.png"><meta property="og:site_name" content="The Code Barbarian"><meta property="description" content="[Mongoose 4.13](https://github.com/Automattic/mongoose/blob/master/History.md#4130--2017-11-02) was released last week. As usual, its packed with powerful new features. The most exciting new feature is the ability to set `localField`, `foreignField`, and `ref` dynamically for [virtual populate](http://mongoosejs.com/docs/populate.html#populate-virtuals). The syntax for virtual populate's dynamic properties is slightly different than the one for [conventional populate](http://mongoosejs.com/docs/populate.html#dynamic-ref), but we think this new syntax is much more powerful."><meta name="twitter:image" content="https://i.imgur.com/CSVk0mm.png"></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li><li><a href="/recommendations">recommendations</a></li></ul></div></div><div class="navbar" id="nav"><div class="container"><div class="navbar-header"><a class="navbar-brand big-brand" href="http://thecodebarbarian.com"><img class="logo" src="/images/Barbarian_Head.png"><span class="site-name">The Code Barbarian</span></a></div><div class="navbar-right collapse navbar-collapse" id="home-nav-mobile"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li><a href="/tag/vue.html">Vue</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div class="col-lg-3 col-lg-offset-9 right-bar" id="desktop-right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div></p></div></div></div></div></div><div class="container-fluid hidden-sm hidden-md hidden-lg" id="mobile-sharing-options"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a class="social" href="#disqus_thread"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div class="post-sharing-options hidden-xs pull-left" id="desktop-sharing-options"><ul class="list-unstyled"><li class="twitter-share"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">What's New In Mongoose 4.13: Dynamic Refs and Fields for Virtual Populate</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">November 09, 2017</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>

<div class="native-banner"></div>
</div><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CKYI5K3Y&placement=thecodebarbariancom" id="_carbonads_js"></script><div class="post-body-text-container"><p><a href="https://github.com/Automattic/mongoose/blob/master/History.md#4130--2017-11-02">Mongoose 4.13</a> was released last week. As usual, its packed with powerful new features. The most exciting new feature is the ability to set <code>localField</code>, <code>foreignField</code>, and <code>ref</code> dynamically for <a href="http://mongoosejs.com/docs/populate.html#populate-virtuals">virtual populate</a>. The syntax for virtual populate&#39;s dynamic properties is slightly different than the one for <a href="http://mongoosejs.com/docs/populate.html#dynamic-ref">conventional populate</a>, but we think this new syntax is much more powerful.</p>
<h2 id="introducing-dynamic-virtual-populate-properties">Introducing Dynamic Virtual Populate Properties</h2>
<p>Virtual populate creates a <a href="http://mongoosejs.com/docs/guide.html#virtuals">virtual property</a> (one that is <strong>not</strong> stored in the database) that can look up documents from other collections. There are 4 options for configuring virtual populate, in addition to the name of the virtual: <code>ref</code>, <code>localField</code>, <code>foreignField</code>, and <code>justOne</code>.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
mongoose.Promise = global.Promise;
mongoose.connect(<span class="hljs-string">'mongodb://localhost:27017/test'</span>, { useMongoClient: <span class="hljs-literal">true</span> });

<span class="hljs-keyword">var</span> PersonSchema = <span class="hljs-keyword">new</span> mongoose.Schema({
  name: <span class="hljs-built_in">String</span>,
  band: <span class="hljs-built_in">String</span>
});

<span class="hljs-keyword">var</span> BandSchema = <span class="hljs-keyword">new</span> mongoose.Schema({
  name: <span class="hljs-built_in">String</span>
}, { toObject: { virtuals: <span class="hljs-literal">true</span> } });
BandSchema.virtual(<span class="hljs-string">'members'</span>, {
  ref: <span class="hljs-string">'Person'</span>, <span class="hljs-comment">// The model to use</span>
  localField: <span class="hljs-string">'name'</span>, <span class="hljs-comment">// Find people where `localField`</span>
  foreignField: <span class="hljs-string">'band'</span>, <span class="hljs-comment">// is equal to `foreignField`</span>
  <span class="hljs-comment">// If `justOne` is true, 'members' will be a single doc as opposed to</span>
  <span class="hljs-comment">// an array. `justOne` is false by default.</span>
  justOne: <span class="hljs-literal">false</span>
});

<span class="hljs-keyword">var</span> Person = mongoose.model(<span class="hljs-string">'Person'</span>, PersonSchema);
<span class="hljs-keyword">var</span> Band = mongoose.model(<span class="hljs-string">'Band'</span>, BandSchema);</code></pre>
<p>You can call <code>.populate(&#39;members&#39;)</code> to find documents in the &#39;Person&#39; model&#39;s collection whose <code>band</code> property equals the band&#39;s <code>name</code> property. For example:</p>
<pre><code class="language-javascript">run().catch(error =&gt; <span class="hljs-built_in">console</span>.error(error));

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">await</span> mongoose.connection.dropDatabase();

  <span class="hljs-keyword">await</span> Person.create([
    { name: <span class="hljs-string">'Axl Rose'</span>, band: <span class="hljs-string">'Guns N\' Roses'</span> },
    { name: <span class="hljs-string">'Slash'</span>, band: <span class="hljs-string">'Guns N\' Roses'</span> },
    { name: <span class="hljs-string">'Vince Neil'</span>, band: <span class="hljs-string">'Motley Crue'</span> },
    { name: <span class="hljs-string">'Nikki Sixx'</span>, band: <span class="hljs-string">'Motley Crue'</span> }
  ])

  <span class="hljs-keyword">await</span> Band.create([
    { name: <span class="hljs-string">'Guns N\' Roses'</span> },
    { name: <span class="hljs-string">'Motley Crue'</span> }
  ])

  <span class="hljs-keyword">const</span> docs = <span class="hljs-keyword">await</span> Band.find().sort({ name: <span class="hljs-number">1</span> }).populate(<span class="hljs-string">'members'</span>);
  <span class="hljs-comment">// { _id: 5a049172eff7d3338724f40a,</span>
  <span class="hljs-comment">//   name: 'Guns N\' Roses',</span>
  <span class="hljs-comment">//   __v: 0,</span>
  <span class="hljs-comment">//   members:</span>
  <span class="hljs-comment">//     [ { _id: 5a049172eff7d3338724f407,</span>
  <span class="hljs-comment">//         name: 'Slash',</span>
  <span class="hljs-comment">//         band: 'Guns N\' Roses',</span>
  <span class="hljs-comment">//         __v: 0 },</span>
  <span class="hljs-comment">//        { _id: 5a049172eff7d3338724f406,</span>
  <span class="hljs-comment">//          name: 'Axl Rose',</span>
  <span class="hljs-comment">//          band: 'Guns N\' Roses',</span>
  <span class="hljs-comment">//          __v: 0 } ],</span>
  <span class="hljs-comment">//   id: '5a049172eff7d3338724f40a' }</span>
  <span class="hljs-built_in">console</span>.log(docs[<span class="hljs-number">0</span>]);
  <span class="hljs-comment">// { _id: 5a049172eff7d3338724f40b,</span>
  <span class="hljs-comment">//   name: 'Motley Crue',</span>
  <span class="hljs-comment">//   __v: 0,</span>
  <span class="hljs-comment">//   members:</span>
  <span class="hljs-comment">//     [ { _id: 5a049172eff7d3338724f409,</span>
  <span class="hljs-comment">//         name: 'Nikki Sixx',</span>
  <span class="hljs-comment">//         band: 'Motley Crue',</span>
  <span class="hljs-comment">//         __v: 0 },</span>
  <span class="hljs-comment">//       { _id: 5a049172eff7d3338724f408,</span>
  <span class="hljs-comment">//         name: 'Vince Neil',</span>
  <span class="hljs-comment">//         band: 'Motley Crue',</span>
  <span class="hljs-comment">//         __v: 0 } ],</span>
  <span class="hljs-comment">//   id: '5a049172eff7d3338724f40b' }</span>
  <span class="hljs-built_in">console</span>.log(docs[<span class="hljs-number">1</span>]);
}</code></pre>
<p>Before mongoose 4.13, <code>localField</code>, <code>foreignField</code>, and <code>ref</code> had to be strings, so they couldn&#39;t change based on the document. In mongoose 4.13 you can still set these properties to strings, but you can also set them to <em>functions</em> that take the current document as a parameter. This means you can determine what <code>localField</code>, <code>foreignField</code>, and <code>ref</code> are depending on the doc being populated.</p>
<p>For example, lets say you had 2 models, &#39;Person&#39; and &#39;Organization&#39;, and people and organizations can send messages to each other represented by a &#39;Message&#39; model. Suppose you wanted <code>from</code> and <code>to</code> virtuals that you could populate to the correct sender and recipient for the message. Before mongoose 4.13, this would not be possible with virtual populate because people and organizations are in separate collections. However, now that <code>ref</code> can be dynamic, you can do this:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
mongoose.Promise = global.Promise;
mongoose.connect(<span class="hljs-string">'mongodb://localhost:27017/test'</span>, { useMongoClient: <span class="hljs-literal">true</span> });

<span class="hljs-keyword">var</span> PersonSchema = <span class="hljs-keyword">new</span> mongoose.Schema({
  name: <span class="hljs-built_in">String</span>
});

<span class="hljs-keyword">var</span> OrganizationSchema = <span class="hljs-keyword">new</span> mongoose.Schema({
  name: <span class="hljs-built_in">String</span>
});

<span class="hljs-keyword">var</span> MessageSchema = <span class="hljs-keyword">new</span> mongoose.Schema({
  fromModel: <span class="hljs-built_in">String</span>,
  fromId: mongoose.Schema.Types.ObjectId,
  toModel: <span class="hljs-built_in">String</span>,
  toId: mongoose.Schema.Types.ObjectId
}, { toObject: { virtuals: <span class="hljs-literal">true</span> } });

MessageSchema.virtual(<span class="hljs-string">'from'</span>, {
  ref: doc =&gt; doc.fromModel, <span class="hljs-comment">// The model to use, conditional on the doc</span>
  localField: <span class="hljs-string">'fromId'</span>, <span class="hljs-comment">// Find people or organizations where `localField`</span>
  foreignField: <span class="hljs-string">'_id'</span>, <span class="hljs-comment">// is equal to `foreignField`</span>
  justOne: <span class="hljs-literal">true</span> <span class="hljs-comment">// and return only one</span>
});

MessageSchema.virtual(<span class="hljs-string">'to'</span>, {
  ref: doc =&gt; doc.toModel, <span class="hljs-comment">// The model to use, conditional on the doc</span>
  localField: <span class="hljs-string">'toId'</span>, <span class="hljs-comment">// Find people or organizations where `localField`</span>
  foreignField: <span class="hljs-string">'_id'</span>, <span class="hljs-comment">// is equal to `foreignField`</span>
  justOne: <span class="hljs-literal">true</span> <span class="hljs-comment">// and return only one</span>
});

<span class="hljs-keyword">var</span> Person = mongoose.model(<span class="hljs-string">'Person'</span>, PersonSchema);
<span class="hljs-keyword">var</span> Organization = mongoose.model(<span class="hljs-string">'Organization'</span>, OrganizationSchema);
<span class="hljs-keyword">var</span> Message = mongoose.model(<span class="hljs-string">'Message'</span>, MessageSchema);</code></pre>
<p>Here&#39;s how using these models looks. Mongoose abstracts out the interaction with <code>fromModel</code> and <code>toModel</code>. So all you need to do is <code>.populate(&#39;from to&#39;)</code> and you get the correct organization or person, depending on the value of <code>fromModel</code> and <code>toModel</code>.</p>
<pre><code class="language-javascript">run().catch(error =&gt; <span class="hljs-built_in">console</span>.error(error));

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">await</span> mongoose.connection.dropDatabase();

  <span class="hljs-keyword">const</span> [alice, bob] = <span class="hljs-keyword">await</span> Person.create([{ name: <span class="hljs-string">'Alice'</span> }, { name: <span class="hljs-string">'Bob'</span> }]);
  <span class="hljs-keyword">const</span> organization = <span class="hljs-keyword">await</span> Organization.create({ name: <span class="hljs-string">'C Corp'</span> });

  <span class="hljs-keyword">const</span> messages = <span class="hljs-keyword">await</span> Message.create([
    {
      fromModel: <span class="hljs-string">'Person'</span>,
      fromId: alice._id,
      toModel: <span class="hljs-string">'Person'</span>,
      toId: bob._id,
      body: <span class="hljs-string">'Hi Bob'</span>
    },
    {
      fromModel: <span class="hljs-string">'Organization'</span>,
      fromId: organization._id,
      toModel: <span class="hljs-string">'Person'</span>,
      toId: bob._id,
      body: <span class="hljs-string">'Alice has sent you a message, accept?'</span>
    },
    {
      fromModel: <span class="hljs-string">'Person'</span>,
      fromId: bob._id,
      toModel: <span class="hljs-string">'Organization'</span>,
      toId: organization._id,
      body: <span class="hljs-string">'Yes'</span>
    }
  ]);

  <span class="hljs-keyword">const</span> docs = <span class="hljs-keyword">await</span> Message.find().sort({ _id: <span class="hljs-number">1</span> }).populate(<span class="hljs-string">'from to'</span>);
  <span class="hljs-comment">// { _id: 5a049618a62ecf3611b55a6c, name: 'Alice', __v: 0 }</span>
  <span class="hljs-built_in">console</span>.log(docs[<span class="hljs-number">0</span>].from);
  <span class="hljs-comment">// { _id: 5a049618a62ecf3611b55a6d, name: 'Bob', __v: 0 }</span>
  <span class="hljs-built_in">console</span>.log(docs[<span class="hljs-number">0</span>].to);
  <span class="hljs-comment">// { _id: 5a049618a62ecf3611b55a6e, name: 'C Corp', __v: 0 }</span>
  <span class="hljs-built_in">console</span>.log(docs[<span class="hljs-number">1</span>].from);
  <span class="hljs-comment">// { _id: 5a049618a62ecf3611b55a6d, name: 'Bob', __v: 0 }</span>
  <span class="hljs-built_in">console</span>.log(docs[<span class="hljs-number">1</span>].to);
  <span class="hljs-comment">// { _id: 5a049618a62ecf3611b55a6d, name: 'Bob', __v: 0 }</span>
  <span class="hljs-built_in">console</span>.log(docs[<span class="hljs-number">2</span>].from);
  <span class="hljs-comment">// { _id: 5a049618a62ecf3611b55a6e, name: 'C Corp', __v: 0 }</span>
  <span class="hljs-built_in">console</span>.log(docs[<span class="hljs-number">2</span>].to);
}</code></pre>
<h2 id="dynamic-localfield-and-foreignfield">Dynamic <code>localField</code> and <code>foreignField</code></h2>
<p>Dynamic refs are supported in conventional populate as well as virtual populate, but the limitation of conventional populate was always the fact that the fields were fixed. Conventional populate is like virtual populate, except <code>foreignField</code> must always be <code>_id</code>. The primary reason for adding virtual populate was letting you specify <code>localField</code> and <code>foreignField</code>, and mongoose 4.13 brings that promise to fruition by making <code>localField</code> and <code>foreignField</code> fully dynamic on a per-document basis.</p>
<p>For example, let&#39;s say you had an &#39;Assignment&#39; model that models assigning a task to either a &#39;User&#39; or an &#39;Admin&#39;. If an admin is assigned, that overwrites the user&#39;s assignment, regardless of whether a user is also assigned. Here&#39;s how you would create the <code>assigned</code> virtual:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);
mongoose.Promise = global.Promise;
mongoose.connect(<span class="hljs-string">'mongodb://localhost:27017/test'</span>, { useMongoClient: <span class="hljs-literal">true</span> });

<span class="hljs-keyword">var</span> PersonSchema = <span class="hljs-keyword">new</span> mongoose.Schema({
  name: <span class="hljs-built_in">String</span>
});

<span class="hljs-keyword">var</span> AdminSchema = <span class="hljs-keyword">new</span> mongoose.Schema({
  name: <span class="hljs-built_in">String</span>
});

<span class="hljs-keyword">var</span> AssignmentSchema = <span class="hljs-keyword">new</span> mongoose.Schema({
  userId: mongoose.Schema.Types.ObjectId,
  adminId: mongoose.Schema.Types.ObjectId
}, { toObject: { virtuals: <span class="hljs-literal">true</span> } });

AssignmentSchema.virtual(<span class="hljs-string">'assigned'</span>, {
  ref: doc =&gt; doc.adminId ? <span class="hljs-string">'Admin'</span> : <span class="hljs-string">'User'</span>,
  localField: doc =&gt; doc.adminId ? <span class="hljs-string">'adminId'</span> : <span class="hljs-string">'userId'</span>,
  foreignField: <span class="hljs-string">'_id'</span>,
  justOne: <span class="hljs-literal">true</span>
});

<span class="hljs-keyword">var</span> User = mongoose.model(<span class="hljs-string">'User'</span>, UserSchema);
<span class="hljs-keyword">var</span> Admin = mongoose.model(<span class="hljs-string">'Admin'</span>, AdminSchema);
<span class="hljs-keyword">var</span> Assignment = mongoose.model(<span class="hljs-string">'Assignment'</span>, AssignmentSchema);</code></pre>
<p>Here&#39;s an example of these models in action:</p>
<pre><code class="language-javascript">run().catch(error =&gt; <span class="hljs-built_in">console</span>.error(error));

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">await</span> mongoose.connection.dropDatabase();

  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> User.create({ name: <span class="hljs-string">'Homer Simpson'</span> });
  <span class="hljs-keyword">const</span> admin = <span class="hljs-keyword">await</span> Admin.create({ name: <span class="hljs-string">'Mr. Burns'</span> });

  <span class="hljs-keyword">await</span> Assignment.create([
    { userId: user._id },
    { userId: user._id, adminId: admin._id }
  ]);

  <span class="hljs-keyword">const</span> docs = <span class="hljs-keyword">await</span> Assignment.find().sort({ _id: <span class="hljs-number">1</span> }).populate(<span class="hljs-string">'assigned'</span>);

  <span class="hljs-comment">// [ { _id: 5a049d28425f8b3a90dfd892, name: 'Homer Simpson', __v: 0 },</span>
  <span class="hljs-comment">//   { _id: 5a049d28425f8b3a90dfd893, name: 'Mr. Burns', __v: 0 } ]</span>
  <span class="hljs-built_in">console</span>.log(docs.map(doc =&gt; doc.assigned));
}</code></pre>
<h2 id="moving-on">Moving On</h2>
<p>Virtual populate&#39;s new support for dynamic per-document <code>ref</code>, <code>localField</code>, and <code>foreignField</code> opens up a lot of new and powerful design patterns. I&#39;m really excited to see what <a href="http://mongoosejs.com/docs/plugins.html">plugins</a> people come up with. Mongoose 4.13 has <a href="https://github.com/Automattic/mongoose/blob/master/History.md#4130--2017-11-02">9 other new features</a>, including middleware for <code>.aggregate()</code>, so make sure you upgrade and take advantage of the new functionality! </p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/#{post.src.substr('./lib/posts/'.length)}">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname
}));</script><link rel="stylesheet" href="/style/inlinecpc.css"></body></html>