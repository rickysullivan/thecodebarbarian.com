<!DOCTYPE html><html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>Getting Started with Apache Kafka in Node.js | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"><link href="/style/style.css" rel="stylesheet" type="text/css"><link href="/style/github.css" rel="stylesheet" type="text/css"><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="Getting Started with Apache Kafka in Node.js"><meta property="og:url" content="http://www.thecodebarbarian.com/getting-started-with-apache-kafka-in-node-js"><meta property="og:image" content="/images/was3.jpg"><meta property="og:site_name" content="The Code Barbarian"><meta property="description" content="Kafka is a powerful distributed pub/sub platform that is popular in large organizations. Here's how you can get started with Kafka in Node.js using the KafkaJS npm module."><meta name="twitter:image" content="/images/was3.jpg"></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li><li><a href="/recommendations">recommendations</a></li></ul></div></div><div class="navbar" id="nav"><div class="container"><div class="navbar-header"><a class="navbar-brand big-brand" href="http://thecodebarbarian.com"><img class="logo" src="/images/Barbarian_Head.png"><span class="site-name">The Code Barbarian</span></a></div><div class="navbar-right collapse navbar-collapse" id="home-nav-mobile"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li><a href="/tag/vue.html">Vue</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div class="col-lg-3 col-lg-offset-9 right-bar" id="desktop-right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div></p></div></div></div></div></div><div class="container-fluid hidden-sm hidden-md hidden-lg" id="mobile-sharing-options"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a class="social" href="#disqus_thread"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div class="post-sharing-options hidden-xs pull-left" id="desktop-sharing-options"><ul class="list-unstyled"><li class="twitter-share"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">Getting Started with Apache Kafka in Node.js</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">February 11, 2021</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>

<div class="native-banner"></div>
</div><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CVAIKKQM&placement=carbonadsnet" id="_carbonads_js"></script><div class="post-body-text-container"><p><a href="https://kafka.apache.org/">Apache Kafka</a> is a popular platform for streaming and pub/sub. It is very common at large companies with massive engineering teams, and less common at smaller companies. That is because, unlike many other alternatives in the message queue space, Kafka focuses on being a high performance write log without strictly enforcing message receipt. In other words, Kafka is less of a traditional message queue and more like a distributed <a href="https://nodejs.org/api/events.html#events_class_eventemitter">event emitter</a>, which is great for cases where you may have dozens of different services looking at a particular message.</p>
<p>Here&#39;s how you can get started working with Kafka in Node.js.</p>
<h2 id="setting-up-kafka-locally">Setting Up Kafka Locally</h2>
<p>First, you need to <a href="https://kafka.apache.org/quickstart">set up Kafka locally</a>. There are also <a href="https://www.confluent.io/blog/kafka-made-serverless-with-confluent-cloud/">cloud services for Kafka</a> if you prefer that approach.</p>
<p>Kafka requires you to have Java 8+ installed on your machine. On Ubuntu, you can just run <code>sudo apt-get install default-jdk</code>. For other operating systems, you can download a <a href="https://www.oracle.com/java/technologies/javase-jdk15-downloads.html">JDK from Oracle</a>.</p>
<p>Once you&#39;ve installed a JDK, you can then download Kafka using <a href="/what-javascript-developers-should-know-about-curl.html">curl</a>.</p>
<pre><code>curl -Ol https://downloads.apache.org/kafka/2.7.0/kafka_2.13-2.7.0.tgz</code></pre><p>Then, extract Kafka using <code>tar -zxvf kafka_2.13-2.7.0.tgz &amp;&amp; cd kafka_2.13-2.7.0</code>.</p>
<p><a href="https://www.confluent.io/blog/removing-zookeeper-dependency-in-kafka/">Kafka still requires Zookeeper</a>, so you need to run 2 services simultaneously to run Kafka. First, start Zookeeper:</p>
<pre><code>bin/zookeeper-server-start.sh config/zookeeper.properties</code></pre><p>Once Zookeeper is running, you can start the Kafka broker. A <em>broker</em> is the service responsible for storing messages and allowing clients to read messages. Zookeeper is responsible for helping brokers coordinate with other brokers. Running the below command starts a broker on port 9092.</p>
<pre><code>bin/kafka-server-start.sh config/server.properties</code></pre><p>Kafka events are broken up into <em>topics</em>. A topic is analagous to a collection in MongoDB or a table in SQL databases. In Kafka, you need to explicitly create a topic before reading or writing messages. The Kafka tarball includes a handy <code>kafka-topics.sh</code> script that lets you create a new topic from the command line:</p>
<pre><code>bin/kafka-topics.sh --create --topic quickstart-events --bootstrap-server localhost:9092</code></pre><p>The above command created a new topic called &quot;quickstart-events&quot;. Now that you have a topic, you can write
some <em>events</em> to the topic. There&#39;s a <code>kafka-console-producer.sh</code> script that lets you enter one or more events. In Kafka, an event is an object with an arbitrary string <code>message</code>. The below shell output shows
creating 2 events: one with message &#39;event 1&#39;, and one with message &#39;event 2&#39;.</p>
<pre><code>$ bin/kafka-console-producer.sh --topic quickstart-events --bootstrap-server localhost:9092
&gt;event 1
&gt;event 2
&gt;^C
$ </code></pre><p>You can then print out these messages with the <code>kafka-console-consumer.sh</code> script:</p>
<pre><code>$ bin/kafka-console-consumer.sh --topic quickstart-events --from-beginning --bootstrap-server localhost:9092
event 1
event 2
^CProcessed a total of 2 messages
$ </code></pre><h2 id="hello-kafkajs">Hello, <a href="https://www.npmjs.com/package/kafkajs">KafkaJS</a></h2>
<p>The command line utilities are neat for getting started, but, in practice, you rarely use Kafka from the command line. <a href="https://www.npmjs.com/package/kafkajs">KafkaJS</a> is currently the most actively maintained Node.js client for Kafka, although <a href="https://www.npmjs.com/package/kafka-node">kafka-node</a> is still popular. For the purposes of this tutorial, I&#39;ll use KafkaJS.</p>
<p>First, let&#39;s connect to Kafka from Node and read the two messages from the &#39;quickstart-events&#39; collection.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> { Kafka } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"kafkajs"</span>);

run().then(() =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Done"</span>), err =&gt; <span class="hljs-built_in">console</span>.log(err));

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> kafka = <span class="hljs-keyword">new</span> Kafka({ brokers: [<span class="hljs-string">"localhost:9092"</span>] });
  <span class="hljs-comment">// If you specify the same group id and run this process multiple times, KafkaJS</span>
  <span class="hljs-comment">// won't get the events. That's because Kafka assumes that, if you specify a</span>
  <span class="hljs-comment">// group id, a consumer in that group id should only read each message at most once.</span>
  <span class="hljs-keyword">const</span> consumer = kafka.consumer({ groupId: <span class="hljs-string">""</span> + <span class="hljs-built_in">Date</span>.now() });

  <span class="hljs-keyword">await</span> consumer.connect();

  <span class="hljs-keyword">await</span> consumer.subscribe({ topic: <span class="hljs-string">"quickstart-events"</span>, fromBeginning: <span class="hljs-literal">true</span> });
  <span class="hljs-keyword">await</span> consumer.run({ 
    eachMessage: <span class="hljs-keyword">async</span> (data) =&gt; {
      <span class="hljs-built_in">console</span>.log(data);
    }
  });
}</code></pre>
<p>The above script will print the below output:</p>
<pre><code>{&quot;level&quot;:&quot;INFO&quot;,&quot;timestamp&quot;:&quot;2021-02-11T16:34:22.411Z&quot;,&quot;logger&quot;:&quot;kafkajs&quot;,&quot;message&quot;:&quot;[Consumer] Starting&quot;,&quot;groupId&quot;:&quot;1613061262395&quot;}
{&quot;level&quot;:&quot;INFO&quot;,&quot;timestamp&quot;:&quot;2021-02-11T16:34:22.425Z&quot;,&quot;logger&quot;:&quot;kafkajs&quot;,&quot;message&quot;:&quot;[ConsumerGroup] Consumer has joined the group&quot;,&quot;groupId&quot;:&quot;1613061262395&quot;,&quot;memberId&quot;:&quot;kafkajs-d042d5ac-44b8-4802-aeaa-c9002ae091e0&quot;,&quot;leaderId&quot;:&quot;kafkajs-d042d5ac-44b8-4802-aeaa-c9002ae091e0&quot;,&quot;isLeader&quot;:true,&quot;memberAssignment&quot;:{&quot;quickstart-events&quot;:[0]},&quot;groupProtocol&quot;:&quot;RoundRobinAssigner&quot;,&quot;duration&quot;:13}
Done
{
  topic: &#39;quickstart-events&#39;,
  partition: 0,
  message: {
    magicByte: 2,
    attributes: 0,
    timestamp: &#39;1613059276111&#39;,
    offset: &#39;0&#39;,
    key: null,
    value: &lt;Buffer 65 76 65 6e 74 20 31&gt;,
    headers: {},
    isControlRecord: false,
    batchContext: {
      firstOffset: &#39;0&#39;,
      firstTimestamp: &#39;1613059276111&#39;,
      partitionLeaderEpoch: 0,
      inTransaction: false,
      isControlBatch: false,
      lastOffsetDelta: 0,
      producerId: &#39;-1&#39;,
      producerEpoch: -1,
      firstSequence: -1,
      maxTimestamp: &#39;1613059276111&#39;,
      timestampType: 0,
      magicByte: 2
    }
  }
}
{
  topic: &#39;quickstart-events&#39;,
  partition: 0,
  message: {
    magicByte: 2,
    attributes: 0,
    timestamp: &#39;1613059277500&#39;,
    offset: &#39;1&#39;,
    key: null,
    value: &lt;Buffer 65 76 65 6e 74 20 32&gt;,
    headers: {},
    isControlRecord: false,
    batchContext: {
      firstOffset: &#39;1&#39;,
      firstTimestamp: &#39;1613059277500&#39;,
      partitionLeaderEpoch: 0,
      inTransaction: false,
      isControlBatch: false,
      lastOffsetDelta: 0,
      producerId: &#39;-1&#39;,
      producerEpoch: -1,
      firstSequence: -1,
      maxTimestamp: &#39;1613059277500&#39;,
      timestampType: 0,
      magicByte: 2
    }
  }
}</code></pre><p>Each event has 3 properties: <code>topic</code>, <code>partition</code>, and <code>message</code>. For the purposes of this tutorial, <code>partition</code> doesn&#39;t matter, we&#39;re just interested in the message. The <code>message.value</code> property contains the message that you generated using <code>kafka-console-producer.sh</code> as a <a href="/an-overview-of-buffers-in-node-js.html">Node.js buffer</a>. Here&#39;s how you can print out the message value as a UTF8 string:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">await</span> consumer.subscribe({ topic: <span class="hljs-string">"quickstart-events"</span>, fromBeginning: <span class="hljs-literal">true</span> });
<span class="hljs-keyword">await</span> consumer.run({ 
  eachMessage: <span class="hljs-keyword">async</span> (data) =&gt; {
    <span class="hljs-comment">// Prints "event 1" followed by "event 2"</span>
    <span class="hljs-built_in">console</span>.log(data.message.value.toString(<span class="hljs-string">"utf8"</span>));
  }
});</code></pre>
<h2 id="producing-events-from-nodejs">Producing Events from Node.js</h2>
<p>KafkaJS has a separate <code>producer()</code> function that creates a new producer object. The previous example created a <code>consumer</code>: consumers can only read messages. Producers can only send messages. Below is how you can send a message &#39;event 3&#39;:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> { Kafka } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"kafkajs"</span>);

run().then(() =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Done"</span>), err =&gt; <span class="hljs-built_in">console</span>.log(err));

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> kafka = <span class="hljs-keyword">new</span> Kafka({ brokers: [<span class="hljs-string">"localhost:9092"</span>] });

  <span class="hljs-keyword">const</span> producer = kafka.producer();
  <span class="hljs-keyword">await</span> producer.connect();

  <span class="hljs-keyword">await</span> producer.send({
    topic: <span class="hljs-string">"quickstart-events"</span>,
    messages: [
      { value: <span class="hljs-string">"event 3"</span> },
    ]
  });
}</code></pre>
<p>KafkaJS consumers automatically read new messages in realtime. And, because of JavaScript&#39;s event loop, you can run a producer and a consumer in the same process. For example, the below script prints 3 events, followed by a 4th event after a 1 second delay.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> { Kafka } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"kafkajs"</span>);

run().then(() =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"Done"</span>), err =&gt; <span class="hljs-built_in">console</span>.log(err));

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> kafka = <span class="hljs-keyword">new</span> Kafka({ brokers: [<span class="hljs-string">"localhost:9092"</span>] });
  <span class="hljs-keyword">const</span> consumer = kafka.consumer({ groupId: <span class="hljs-string">''</span> + <span class="hljs-built_in">Date</span>.now() });

  <span class="hljs-keyword">await</span> consumer.connect();

  <span class="hljs-keyword">await</span> consumer.subscribe({ topic: <span class="hljs-string">'quickstart-events'</span>, fromBeginning: <span class="hljs-literal">true</span> });

  <span class="hljs-keyword">let</span> startTime = <span class="hljs-built_in">Date</span>.now();

  <span class="hljs-keyword">await</span> consumer.run({ 
    eachMessage: <span class="hljs-keyword">async</span> (data) =&gt; {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-built_in">Date</span>.now() - startTime, data.message.value.toString(<span class="hljs-string">'utf8'</span>));
    }
  });

  <span class="hljs-keyword">const</span> producer = kafka.producer();
  <span class="hljs-keyword">await</span> producer.connect();

  <span class="hljs-comment">// Wait 1 second before sending a new message</span>
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(resolve =&gt; setTimeout(resolve, <span class="hljs-number">1000</span>));

  <span class="hljs-keyword">await</span> producer.send({
    topic: <span class="hljs-string">"quickstart-events"</span>,
    messages: [
      { value: <span class="hljs-string">"event 4"</span> },
    ]
  });
}</code></pre>
<p>Below is the output:</p>
<pre><code>29 event 1
30 event 2
30 event 3
Done
1046 event 4</code></pre><h2 id="moving-on">Moving On</h2>
<p>Kafka is a powerful tool that allows large engineering organizations to effectively break up their code into separate services. Instead of having one monolith that handles all business logic itself, a service can send an event to Kafka and delegate the handling of the event without needing to know what consumers are interested in the event. This is great because it enables different services to work together without being aware of each other, meaning you can build a new service without any other service being aware of it. That can be a huge productivity win for large teams.</p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/#{post.src.substr('./lib/posts/'.length)}">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname
}));</script><link rel="stylesheet" href="/style/inlinecpc.css"></body></html>