<!DOCTYPE html><html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>What's New in Mongoose 6.8: Deno Support and Document-Specific Validation Error Messages | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"><link href="/style/style.css" rel="stylesheet" type="text/css"><link href="/style/github.css" rel="stylesheet" type="text/css"><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="What's New in Mongoose 6.8: Deno Support and Document-Specific Validation Error Messages"><meta property="og:url" content="http://www.thecodebarbarian.com/whats-new-in-mongoose-6-8-deno-and-error-messages"><meta property="og:image" content="https://images.unsplash.com/photo-1613864557842-388228d9cbf4?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1631&amp;q=80"><meta property="og:site_name" content="The Code Barbarian"><meta property="description" content="Mongoose 6.8.0 introduces support for Deno and several other new features. Here's what you need to know."><meta name="twitter:image" content="https://images.unsplash.com/photo-1613864557842-388228d9cbf4?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1631&amp;q=80"></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li><li><a href="/recommendations">recommendations</a></li></ul></div></div><div class="navbar" id="nav"><div class="container"><div class="navbar-header"><a class="navbar-brand big-brand" href="http://thecodebarbarian.com"><img class="logo" src="/images/Barbarian_Head.png"><span class="site-name">The Code Barbarian</span></a></div><div class="navbar-right collapse navbar-collapse" id="home-nav-mobile"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li><a href="/tag/vue.html">Vue</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div class="col-lg-3 col-lg-offset-9 right-bar" id="desktop-right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div></p></div></div></div></div></div><div class="container-fluid hidden-sm hidden-md hidden-lg" id="mobile-sharing-options"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a class="social" href="#disqus_thread"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div class="post-sharing-options hidden-xs pull-left" id="desktop-sharing-options"><ul class="list-unstyled"><li class="twitter-share"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">What's New in Mongoose 6.8: Deno Support and Document-Specific Validation Error Messages</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">December 15, 2022</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>

<div class="native-banner"></div>
</div><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CKYI5K3Y&placement=thecodebarbariancom" id="_carbonads_js"></script><div class="post-body-text-container"><p><a href="https://github.com/Automattic/mongoose/releases/tag/6.8.0">Mongoose 6.8.0 was released on December 5, 2022</a> and includes several cool new features.
The most notable change is alpha support for <a href="https://deno.land/">Deno</a>.
Deno support is a huge step for Mongoose, because this is the first time Mongoose has introduced support for a server-side JavaScript runtime that isn&#39;t Node.
This blog post will also cover document-specific validation error messages, another new feature in 6.8.</p>
<h2 id="using-mongoose-with-deno">Using Mongoose with Deno</h2>
<p><a href="https://deno.land/">Deno</a> is a server-side JavaScript runtime.
It serves a similar purpose to Node, but Deno makes several different design decisions, like default support for ESM and denying access to the file system by default.
With Mongoose 6.8 and Deno 1.28, you can import Mongoose using <a href="https://deno.land/std@0.166.0/node/README.md?source=#commonjs-modules-loading">Deno&#39;s CommonJS module compatibility layer</a> as follows.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">import</span> { createRequire } <span class="hljs-keyword">from</span> <span class="hljs-string">'https://deno.land/std/node/module.ts'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-built_in">require</span> = createRequire(<span class="hljs-keyword">import</span>.meta.url);

<span class="hljs-keyword">const</span> mongoose = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongoose'</span>);

mongoose.connect(<span class="hljs-string">'mongodb://localhost:27017/test'</span>)
  .then(() =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Connected!'</span>));</code></pre>
<p>You can then run the above script using the following command.</p>
<pre><code>deno run --allow-read --allow-env --allow-net --allow-sys ./deno-test.js </code></pre><p>Mongoose requires the following Deno permissions:</p>
<ul>
<li><code>allow-read</code> because CommonJS <code>require()</code> reads from the file system</li>
<li><code>allow-env</code> because the MongoDB Node driver reads certain environment variables for AWS credentials support</li>
<li><code>allow-net</code> to open a socket connection to MongoDB</li>
<li><code>allow-sys</code> because the MongoDB Node driver reads information about your OS release</li>
</ul>
<p>You can also use Deno&#39;s new <a href="https://deno.land/manual@v1.29.0/node/npm_specifiers">npm specifiers</a> to import Mongoose.
We currently use <code>createRequire()</code> in Mongoose&#39;s docs and test suite, but npm specifiers also work.
With npm specifiers, you still need to load Deno&#39;s <code>std/node</code> polyfill, because Mongoose uses Node built-ins like <code>process</code>.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">'https://deno.land/std/node/module.ts'</span>;
<span class="hljs-keyword">import</span> mongoose <span class="hljs-keyword">from</span> <span class="hljs-string">'npm:mongoose@6'</span>;

mongoose.connect(<span class="hljs-string">'mongodb://localhost:27017/test'</span>)
  .then(() =&gt; <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Connected!'</span>));</code></pre>
<p>Keep in mind that Mongoose&#39;s support for Deno is new, there will likely be unforeseen bugs.
We&#39;re currently running a simple Mongoose app in production with Deno, and we haven&#39;t run into any issues.
But we advise using caution if you&#39;re looking to switch an existing Mongoose app over to Deno, or using Mongoose in an existing Deno app.</p>
<p>In particular, it is worth noting that, while Mongoose does support Deno, the MongoDB Node driver that Mongoose uses to talk to MongoDB does not.
If you run into any issues, please report them on <a href="https://github.com/Automattic/mongoose/issues/new/choose">Mongoose&#39;s GitHub</a>.</p>
<h2 id="document-specific-validation-error-messages">Document-Specific Validation Error Messages</h2>
<p>Document-specific validation error messages are a much smaller, but still very useful, new feature in Mongoose 6.8.
Mongoose supports custom validation errors: when a validator function returns a falsy value, Mongoose creates a new validator error with the given error message.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> userSchema = <span class="hljs-keyword">new</span> mongoose.Schema({
  email: {
    type: <span class="hljs-built_in">String</span>,
    match: [
      <span class="hljs-regexp">/^[^@]+@\w+(\.\w+)+\w$/</span>, <span class="hljs-comment">// Regex from https://masteringjs.io/tutorials/fundamentals/email-validation</span>
      <span class="hljs-string">'Email is invalid'</span> <span class="hljs-comment">// Error message if email doesn't match</span>
    ]
  }
});

<span class="hljs-keyword">const</span> User = mongoose.model(<span class="hljs-string">'User'</span>, userSchema);

<span class="hljs-keyword">const</span> doc = <span class="hljs-keyword">new</span> User({ email: <span class="hljs-string">'fail'</span> });
<span class="hljs-comment">// "User validation failed: email: Please enter a valid email address"</span>
<span class="hljs-built_in">console</span>.log(doc.validateSync());</code></pre>
<p>The 2nd element in the <code>match</code> array is the message that Mongoose reports if the <code>email</code> doesn&#39;t match the given regular expression.
The message parameter can also be a function.
If the message parameter is a function, Mongoose calls the function with the current value as the first argument.</p>
<p>As of Mongoose 6.8, Mongoose also passes the current document being validated as the 2nd argument to the message function.
This makes it easier to switch the error message based on a different property of the document.
For example, suppose you want to switch the language of the error message based on a <code>locale</code> property in the document.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> messages = {
  en: <span class="hljs-string">'Email is invalid'</span>, <span class="hljs-comment">// English</span>
  es: <span class="hljs-string">'Email es invalido'</span> <span class="hljs-comment">// Spanish</span>
};

<span class="hljs-keyword">const</span> userSchema = <span class="hljs-keyword">new</span> mongoose.Schema({
  locale: {
    type: <span class="hljs-built_in">String</span>,
    enum: [<span class="hljs-string">'en'</span>, <span class="hljs-string">'es'</span>],
    <span class="hljs-keyword">default</span>: <span class="hljs-string">'en'</span>
  },
  email: {
    type: <span class="hljs-built_in">String</span>,
    match: [
      <span class="hljs-regexp">/^[^@]+@\w+(\.\w+)+\w$/</span>, <span class="hljs-comment">// Regex from https://masteringjs.io/tutorials/fundamentals/email-validation</span>
      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">formatEmailValidatorError</span>(<span class="hljs-params">value, doc</span>) </span>{
        <span class="hljs-comment">// `doc` parameter is new in Mongoose 6.8.</span>
        <span class="hljs-keyword">return</span> messages[doc.locale];
      }
    ]
  }
});</code></pre>
<h2 id="moving-on">Moving On</h2>
<p>Deno support is the most exciting new feature in Mongoose 6.8.
This represents a big step forward for Mongoose, as the first major step we&#39;ve taken outside of Node since we introduced basic browser support in 2015 with 4.0.
There are 7 other new features in 6.8 as well, including document-specific validation error messages, a <code>$clone()</code> method for <a href="https://mongoosejs.com/docs/documents.html">documents</a>, and automatically inferred <a href="https://mongoosejs.com/docs/timestamps.html">timestamps</a> in TypeScript.
Make sure you upgrade to take advantage of the new features!</p>
<p><em>Want to become your team&#39;s MongoDB expert? &quot;Mastering Mongoose&quot; distills 10 years of hard-earned lessons building Mongoose apps at scale into 153 pages. That means you can learn what you need to know to build production-ready full-stack apps with Node.js and MongoDB in a few days. <a href="https://masteringjs.io/ebooks/mastering-mongoose">Get your copy</a>!</em></p>
<a href="https://masteringjs.io/ebooks/mastering-mongoose" class="async-await-banner">
  <img src="https://masteringjs.io/ebooks/mastering-mongoose-horizontal.png">
</a></div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/#{post.src.substr('./lib/posts/'.length)}">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname
}));</script><link rel="stylesheet" href="/style/inlinecpc.css"></body></html>