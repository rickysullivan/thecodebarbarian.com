<!DOCTYPE html><html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>Web Analytics with MongoDB Stitch | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"><link href="/style/style.css" rel="stylesheet" type="text/css"><link href="/style/github.css" rel="stylesheet" type="text/css"><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="Web Analytics with MongoDB Stitch"><meta property="og:url" content="http://www.thecodebarbarian.com/web-analytics-with-mongodb-stitch"><meta property="og:image" content="https://i.imgur.com/zbSgrdq.jpg"><meta property="og:site_name" content="The Code Barbarian"><meta property="description" content="One of the most exciting features of [MongoDB Stitch](https://www.mongodb.com/cloud/stitch) is the ability to read and write"><meta name="twitter:image" content="https://i.imgur.com/zbSgrdq.jpg"></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li><li><a href="/recommendations">recommendations</a></li></ul></div></div><div class="navbar" id="nav"><div class="container"><div class="navbar-header"><a class="navbar-brand big-brand" href="http://thecodebarbarian.com"><img class="logo" src="/images/Barbarian_Head.png"><span class="site-name">The Code Barbarian</span></a></div><div class="navbar-right collapse navbar-collapse" id="home-nav-mobile"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li><a href="/tag/vue.html">Vue</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div class="col-lg-3 col-lg-offset-9 right-bar" id="desktop-right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div></p></div></div></div></div></div><div class="container-fluid hidden-sm hidden-md hidden-lg" id="mobile-sharing-options"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a class="social" href="#disqus_thread"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div class="post-sharing-options hidden-xs pull-left" id="desktop-sharing-options"><ul class="list-unstyled"><li class="twitter-share"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">Web Analytics with MongoDB Stitch</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">July 24, 2018</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>

<div class="native-banner"></div>
</div><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CKYI5K3Y&placement=thecodebarbariancom" id="_carbonads_js"></script><div class="post-body-text-container"><p>One of the most exciting features of <a href="https://www.mongodb.com/cloud/stitch">MongoDB Stitch</a> is the ability to read and write
directly to your <a href="https://www.mongodb.com/cloud/atlas">MongoDB Atlas</a> cluster from the browser. In other words, your static site or React app can write
event data directly to MongoDB without having to go through an intermediary
like <a href="https://segment.com/">Segment</a>. This lets you retain ownership of your
event data, as well as help cut costs. In this article, I&#39;ll show you how
to configure a MongoDB Stitch app for tracking events from the browser.</p>
<p><em>Note that this article&#39;s code is just an example and not meant for production use.</em></p>
<h2 id="setting-up-a-stitch-app">Setting Up a Stitch App</h2>
<p>This article assumes you already have a MongoDB Atlas cluster running. If you
don&#39;t, here&#39;s a <a href="https://docs.atlas.mongodb.com/getting-started/">guide to getting started with Atlas</a>.</p>
<p>Go to MongoDB Atlas and open the &quot;Clusters&quot; view. Under &quot;Linked Stitch App&quot;, click
&quot;Link Application&quot; to get started creating a Stitch app.</p>
<img class="inline-image" src="https://i.imgur.com/v14lsQs.png">

<p>Name your Stitch app &quot;analytics&quot; and link it to your cluster. In this case,
the cluster is named &quot;Cluster0&quot;.</p>
<img class="inline-image" src="https://i.imgur.com/VvHfQwS.png">

<p>Next, the Stitch UI will ask you to configure your app. Turn on &quot;Anonymous Authentication&quot; and create a collection <code>analytics.events</code>.</p>
<img class="inline-image" src="https://i.imgur.com/Gw0UDcn.png">

<p>In order to enable writing to your analytics collection, you need to modify
Stitch&#39;s default &quot;Rules&quot;. Click on &quot;Rules&quot; in the left menu and edit the
&quot;Owner&quot; permission under the <code>analytics.events</code> collection. Empty out the
&quot;Apply When&quot; section to make the &quot;Owner&quot; permission never apply.</p>
<img class="inline-image" src="https://i.imgur.com/cYmriyV.png">

<p>Most events tracking tools separate out permissions for reading and writing,
so anyone can write to the database but reads are admin-only. In order to
disallow reads, you need to convert your rules to &quot;Advanced Mode&quot;. Click on
&quot;Convert to Advanced Mode&quot; and ignore the scary warning that pops up.</p>
<img class="inline-image" src="https://i.imgur.com/spM36Qm.png">

<p>Modify your roles to look like what you see below. Now, your Stitch client can
write to the database but not read.</p>
<pre><code>{
  &quot;roles&quot;: [
    {
      &quot;name&quot;: &quot;owner&quot;,
      &quot;apply_when&quot;: {},
      &quot;insert&quot;: true,
      &quot;delete&quot;: false,
      &quot;read&quot;: false,
      &quot;write&quot;: true,
      &quot;fields&quot;: {},
      &quot;additional_fields&quot;: {}
    }
  ],
  &quot;filters&quot;: [],
  &quot;schema&quot;: {
    &quot;properties&quot;: {
      &quot;_id&quot;: {
        &quot;bsonType&quot;: &quot;objectId&quot;
      },
      &quot;owner_id&quot;: {
        &quot;bsonType&quot;: &quot;string&quot;
      }
    }
  }
}</code></pre><h2 id="tracking-your-first-event">Tracking Your First Event</h2>
<p>Install the <a href="https://www.npmjs.com/package/mongodb-stitch-browser-sdk">mongodb-stitch-browser-sdk npm package</a>. MongoDB Stitch
recommends building the browser SDK with <a href="https://www.npmjs.com/package/webpack">webpack</a>, so make sure to install webpack
and webpack-cli. Also,
install <a href="https://www.npmjs.com/package/serve">serve</a> for serving static HTML.</p>
<pre><code>npm install mongodb-stitch-browser-sdk@4.x serve@9.x webpack@4.16.2 webpack-cli@3.1.0 --save</code></pre><p>Next, create a trivial static site <code>index.html</code>. This page will load the
<code>main.js</code> file, which will be responsible for writing to MongoDB Atlas using
the Stitch SDK.</p>
<pre><code>&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;My Site&lt;/title&gt;

    &lt;script type=&quot;text/javascript&quot; src=&quot;dist/main.js&quot;&gt;&lt;/script&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h1&gt;My site&lt;/h1&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre><p>Below is the content of <code>index.js</code>, the entry point for the compiled bundle
that webpack will produce. The below file just writes the current <code>pathname</code>
and the current time to the <code>analytics.events</code> collection.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">import</span> { Stitch, AnonymousCredential, RemoteMongoClient } <span class="hljs-keyword">from</span> <span class="hljs-string">'mongodb-stitch-browser-sdk'</span>;

<span class="hljs-built_in">window</span>.onload = main;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> client = Stitch.initializeDefaultAppClient(<span class="hljs-string">'&lt;your app id here&gt;'</span>);
  client.auth.loginWithCredential(<span class="hljs-keyword">new</span> AnonymousCredential()).
    then(() =&gt; {
      <span class="hljs-keyword">const</span> db = client.getServiceClient(RemoteMongoClient.factory, <span class="hljs-string">'mongodb-atlas'</span>).db(<span class="hljs-string">'analytics'</span>);
      <span class="hljs-keyword">return</span> db.collection(<span class="hljs-string">'events'</span>).insertOne({
        path: <span class="hljs-built_in">window</span>.location.pathname,
        time: <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()
      });
    });
}</code></pre>
<p>You also need a basic webpack config file. For the purposes of this example
you don&#39;t need any tools like <a href="https://www.npmjs.com/package/babel-loader">Babel</a>, but you&#39;ll need those if
you want your code to work with older browsers.</p>
<pre><code class="language-javascript"><span class="hljs-built_in">module</span>.exports = {
  entry: [<span class="hljs-string">'./index.js'</span>],
  <span class="hljs-built_in">module</span>: {
    rules: [{
      test: <span class="hljs-regexp">/\.js$/</span>,
      exclude: <span class="hljs-regexp">/node_modules/i</span>
    }]
  },
  target: <span class="hljs-string">'web'</span>,
  mode: <span class="hljs-string">'production'</span>
};</code></pre>
<p>Run <code>./node_modules/.bin/webpack</code> to compile the bundle and then run
<code>./node_modules/.bin/serve</code> to start a web server.</p>
<pre><code>$ ./node_modules/.bin/webpack
Hash: 7905753ffa4597e049ea
Version: webpack 4.16.2
Time: 3080ms
Built at: 2018-07-24 15:36:53
  Asset     Size  Chunks             Chunk Names
main.js  223 KiB       0  [emitted]  main
Entrypoint main = main.js
 [3] (webpack)/buildin/global.js 489 bytes {0} [built]
 [8] multi ./index.js 28 bytes {0} [built]
[12] ./index.js + 103 modules 169 KiB {0} [built]
     | ./index.js 521 bytes [built]
     |     + 103 hidden modules
    + 10 hidden modules
$
$ ./node_modules/.bin/serve

 Serving!

 - Local:            http://localhost:5000
 - On Your Network:  http://127.0.1.1:5000</code></pre><p>Now, if you visit <code>http://localhost:5000/</code>, you should see a <code>call</code> to
<code>stitch.mongodb.com</code> in your Chrome Network console that contains the id
of an inserted document. Congratulations, you just wrote a document into
your MongoDB Atlas cluster from your browser!</p>
<img class="inline-image" src="https://i.imgur.com/GWSYg8q.png">

<h2 id="crunching-some-numbers">Crunching Some Numbers</h2>
<p>Now that you can write events data to MongoDB from the browser using
Stitch, let&#39;s write a common analytics query using the
<a href="https://docs.mongodb.com/manual/reference/method/db.collection.aggregate/">MongoDB aggregation framework</a>.
Go back to your Atlas clusters page and click &quot;Connect&quot; to open up
instructions for how to connect to your Atlas cluster.</p>
<img class="inline-image" src="https://i.imgur.com/LYScQtP.png">

<p>Connect to your MongoDB Atlas cluster using the MongoDB shell, switch to the
&#39;analytics&#39; database using <code>use analytics;</code> and print out
a document.</p>
<pre><code>mongo &quot;mongodb+srv://cluster0-OMITTED.mongodb.net/test&quot; --username OMITTED
MongoDB shell version v4.0.0
Enter password:
connecting to: mongodb+srv://cluster0-OMITTED.mongodb.net/test
PRIMARY&gt;
PRIMARY&gt; use analytics
switched to db analytics
PRIMARY&gt; db.events.findOne()
{
    &quot;_id&quot; : ObjectId(&quot;5b5780681c9d4400000d6643&quot;),
    &quot;path&quot; : &quot;/&quot;,
    &quot;time&quot; : ISODate(&quot;2018-07-24T19:39:20.253Z&quot;)
}
PRIMARY&gt;</code></pre><p>In order to make this example more realistic, insert several more documents
into the collection using the below command:</p>
<pre><code class="language-javascript">db.events.insertMany([
  { path: <span class="hljs-string">'/'</span>, time: ISODate(<span class="hljs-string">'2018-07-24'</span>) },
  { path: <span class="hljs-string">'/'</span>, time: ISODate(<span class="hljs-string">'2018-07-23'</span>) },
  { path: <span class="hljs-string">'/'</span>, time: ISODate(<span class="hljs-string">'2017-07-24'</span>) }
]);</code></pre>
<p>Let&#39;s use the aggregation framework to count up the number of hits per day. The
key is to group events by the day, month, and year they occurred using
<a href="https://docs.mongodb.com/v3.4/reference/operator/aggregation-date/">date aggregation operators</a></p>
<pre><code class="language-javascript">db.events.aggregate([
  {
    $group: {
      _id: {
        <span class="hljs-comment">// Pull day, month, year from the 'time' property of each doc</span>
        day: { $dayOfMonth: <span class="hljs-string">'$time'</span> },
        month: { $month: <span class="hljs-string">'$time'</span> },
        year: { $year: <span class="hljs-string">'$time'</span> }
      },
      num: {
        $sum: <span class="hljs-number">1</span>
      }
    }
  },
  {
    <span class="hljs-comment">// Sort by date, descending</span>
    $sort: { <span class="hljs-string">'_id.year'</span>: <span class="hljs-number">-1</span>, <span class="hljs-string">'_id.month'</span>: <span class="hljs-number">-1</span>, <span class="hljs-string">'_id.day'</span>: <span class="hljs-number">-1</span> }
  }
]);</code></pre>
<p>Running this aggregation query gets you how many events occurred on a given
day.</p>
<pre><code>{ &quot;_id&quot; : { &quot;day&quot; : 24, &quot;month&quot; : 7, &quot;year&quot; : 2018 }, &quot;num&quot; : 2 }
{ &quot;_id&quot; : { &quot;day&quot; : 23, &quot;month&quot; : 7, &quot;year&quot; : 2018 }, &quot;num&quot; : 1 }
{ &quot;_id&quot; : { &quot;day&quot; : 24, &quot;month&quot; : 7, &quot;year&quot; : 2017 }, &quot;num&quot; : 1 }</code></pre><h2 id="moving-on">Moving On</h2>
<p>MongoDB Stitch allows you to access your MongoDB Atlas cluster directly from
the browser, without needing to go through your own API. One potential use case
for this is analytics: instead of going through <a href="https://mixpanel.com/">Mixpanel</a> or <a href="https://marketingplatform.google.com/about/">Google Analytics</a> UI, you can
store your data in MongoDB and use the MongoDB aggregation framework or <a href="https://www.mongodb.com/products/charts">MongoDB Charts</a> to analyze it. While it may
be a little early to close your Mixpanel account, MongoDB Stitch is worth
looking into if you&#39;re already a MongoDB power user.</p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/#{post.src.substr('./lib/posts/'.length)}">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname
}));</script><link rel="stylesheet" href="/style/inlinecpc.css"></body></html>