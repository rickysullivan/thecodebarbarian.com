<!DOCTYPE html><html><head><script type="text/javascript">var _sf_startpt=(new Date()).getTime()
</script><title>Getting Started With IBM Cloud Functions and MongoDB | www.thecodebarbarian.com</title><meta name="viewport" content="width=device-width, initial-scale=1"><link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:200,300,400,600" rel="stylesheet" type="text/css"><link href="//fonts.googleapis.com/css?family=Merriweather:400,400italic,600,700" rel="stylesheet" type="text/css"><link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet"><link href="/style/style.css" rel="stylesheet" type="text/css"><link href="/style/github.css" rel="stylesheet" type="text/css"><script href="http://code.jquery.com/jquery-2.1.1.min.js" type="text/javascript"></script><script href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js" type="text/javascript"></script><script href="/javascript/sidebar.js" type="text/javascript"></script><meta property="og:title" content="Getting Started With IBM Cloud Functions and MongoDB"><meta property="og:url" content="http://www.thecodebarbarian.com/getting-started-with-ibm-cloud-functions-and-mongodb"><meta property="og:image" content="https://i.imgur.com/nfDBmrx.jpg"><meta property="og:site_name" content="The Code Barbarian"><meta property="description" content="Serverless architectures are becoming increasingly popular, and with good"><meta name="twitter:image" content="https://i.imgur.com/nfDBmrx.jpg"></head><body><div class="navbar social-links hidden-sm hidden-xs"><div class="container"><ul class="nav navbar-nav navbar-right"><li><a href="http://www.twitter.com/code_barbarian">twitter</a></li><li><a href="http://www.github.com/vkarpov15">github</a></li><li><a href="http://thecodebarbarian.com/feed.xml">rss</a></li><li><a href="/recommendations">recommendations</a></li></ul></div></div><div class="navbar" id="nav"><div class="container"><div class="navbar-header"><a class="navbar-brand big-brand" href="http://thecodebarbarian.com"><img class="logo" src="/images/Barbarian_Head.png"><span class="site-name">The Code Barbarian</span></a></div><div class="navbar-right collapse navbar-collapse" id="home-nav-mobile"><ul class="nav navbar-nav"><li><a href="/tag/mongodb.html">MongoDB</a></li><li><a href="/tag/nodejs.html">NodeJS</a></li><li><a href="/tag/asyncawait.html">Async/Await</a></li><li><a href="/tag/vue.html">Vue</a></li><li class="hidden-md hidden-lg"><a href="#">@code_barbarian</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Github</a></li><li class="hidden-md hidden-lg"><a href="#">TCB Facebook</a></li></ul></div></div></div><div class="container-fluid"><div class="col-lg-3 col-lg-offset-9 right-bar" id="desktop-right-bar"><div class="right-bar-content-slider pull-right"><div class="row recent-posts right-bar-group"><div class="col-lg-12 articles"><p class="right-bar-label">Most Popular Articles</p><ul class="list-unstyled"><li class="right-bar-li"><a href="/common-async-await-design-patterns-in-node.js.html">Common Async/Await Design Patterns in Node.js</a></li><li class="right-bar-li"><a href="/unhandled-promise-rejections-in-node.js.html">Unhandled Promise Rejections in Node.js</a></li><li class="right-bar-li"><a href="/using-async-await-with-mocha-express-and-mongoose">Using Async/Await with Mocha, Express, and Mongoose</a></li><li class="right-bar-li"><a href="/write-your-own-node-js-promise-library-from-scratch.html">Write Your Own Node.js Promise Library from Scratch</a></li><li class="right-bar-li"><a href="/80-20-guide-to-express-error-handling">The 80/20 Guide to Express Error Handling</a></li></ul></div></div><div class="row recent-posts right-bar-group"><div class="col-lg-12 books"><p class="right-bar-label">Ebooks<div><a href="http://asyncawait.net/?utm_source=thecodebarbarian&amp;utm_campaign=sidebar"><img src="/images/verticalbanner.png"></a></div><div><a href="http://es2015generators.com"><img src="https://i.imgur.com/xvGNKlr.png"><p><i>The 80/20 Guide to ES2015 Generators</i></p></a></div></p></div></div></div></div></div><div class="container-fluid hidden-sm hidden-md hidden-lg" id="mobile-sharing-options"><div class="row"><div class="col-lg-12"><style>#home-nav-mobile {
  float: left !important;
  margin-left: 215px !important;
}
</style><div class="post-sharing-options"><div class="row"><div class="col-xs-3 twitter-share sharing-option"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter"></i></a></div><div class="col-xs-3 facebook-share sharing-option"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook"></i></a></div><div class="col-xs-3 google-share sharing-option"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus"></i></a></div><div class="col-xs-3 comment sharing-option"><a class="social" href="#disqus_thread"><i class="fa fa-comment"></i></a></div></div></div></div></div></div><div class="post-sharing-options hidden-xs pull-left" id="desktop-sharing-options"><ul class="list-unstyled"><li class="twitter-share"><a class="social" href="https://twitter.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}&amp;via=code_barbarian"><i class="fa fa-twitter sharing-option"></i></a></li><li class="facebook-share"><a class="social" href="https://www.facebook.com/sharer/sharer.php?u=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-facebook sharing-option"></i></a></li><li class="google-share"><a class="social" href="https://plus.google.com/share?url=#{encodeURIComponent('http://www.thecodebarbarian.com/' + post.dest.directory.substr('./bin'.length) + '/' + post.dest.name)}"><i class="fa fa-google-plus sharing-option"></i></a></li></ul></div><div class="container"><div class="col-lg-9 post-text"><div class="row"><div class="title-byline-container"><h1 class="post-title">Getting Started With IBM Cloud Functions and MongoDB</h1><div class="credits"><span class="byline">by Valeri Karpov</span><span class="byhandle"><a href="http://www.twitter.com/code_barbarian">@code_barbarian</a></span><span class="bydate">March 30, 2018</span></div></div></div><script type="text/javascript" src="/js/native.js"></script><div><script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>

<div class="native-banner"></div>
</div><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?serve=CVAIKKQM&placement=carbonadsnet" id="_carbonads_js"></script><div class="post-body-text-container"><p>Serverless architectures are becoming increasingly popular, and with good
reason. In my experience, unless you are a devops expert or have one on your
team, tools like Docker just make devops harder. With <a href="https://martinfowler.com/articles/serverless.html">FaaS architectures</a>, in theory the
only devops you need is bundling and uploading your app. However, a purely
stateless function would have to make a separate database connection every time
it runs, which is a major performance penalty. Most FaaS services have a workaround
that lets you reuse database connections, like <a href="https://www.mongodb.com/blog/post/serverless-development-with-nodejs-aws-lambda-mongodb-atlas">AWS Lambda</a> and <a href="http://thecodebarbarian.com/getting-started-with-azure-functions-and-mongodb.html">Azure Functions</a>. <a href="https://console.bluemix.net/openwhisk/">IBM Cloud Functions</a> is IBM&#39;s
equivalent to Lambda and Azure Functions. This article will walk you through setting up an IBM Cloud Function in Node.js that connects to MongoDB and reuses the database connection between requests.</p>
<h2 id="creating-a-simple-ibm-cloud-function">Creating a Simple IBM Cloud Function</h2>
<p>Go to <a href="https://console.bluemix.net/openwhisk/">IBM&#39;s OpenWhisk landing page</a> and log in. <a href="https://openwhisk.apache.org/">OpenWhisk</a> is an Apache open source project
that provides the underlying framework for IBM Cloud Functions. In theory, you
could run OpenWhisk yourself and use the same deployment strategy you do for
IBM Cloud, but I haven&#39;t tried this.</p>
<p>Once you&#39;ve logged in, click on the &quot;Actions&quot; tab on the left and then click &quot;Create.&quot;</p>
<img src="https://i.imgur.com/b9qp4S7.png">

<p>For this simple example, click on &quot;Quickstart Templates&quot; to get a list of ready-made &quot;actions&quot;. OpenWhisk calls functions &quot;actions&quot;, presumably because
actions have a very specific function signature.</p>
<img src="https://i.imgur.com/a8cUKWD.png">

<p>Select the &quot;Hello World&quot; function template.</p>
<img src="https://i.imgur.com/O3G0oMh.png">

<p>The next step asks you for a package name, a runtime, and the actual code. The
default options are sufficient for this simple example, because IBM Cloud will
fill in the code for a rudimentary &quot;Hello, World&quot; action for you.</p>
<img src="https://i.imgur.com/B7LLZOT.png">

<p>Great, now you have your first cloud function. You can execute the function,
but you still need to expose it via HTTP.
Click the &quot;Endpoints&quot; tab on the left to create an endpoint for this function.</p>
<img src="https://i.imgur.com/4RGJMEp.png">

<p>Now, click the &quot;Enable as Web Action&quot; checkbox to expose this action via REST API. A web action has a couple special
properties as opposed to a regular action. First, a web action <em>must</em> return an object that is serializable into JSON, or
a <a href="https://github.com/apache/incubator-openwhisk/blob/master/docs/actions.md#creating-asynchronous-actions">promise that resolves to such an object</a>. Second, if a web action returns an object that has
a <code>headers</code>, <code>statusCode</code>, or <code>body</code> property, OpenWhisk will use those properties to structure the HTTP response, rather
than just stringifying the resulting JSON object.</p>
<img src="https://i.imgur.com/hxKKJiD.png">


<p>Once you&#39;ve made your action into a web action, you should be able to access it via REST API. Click the copy icon in
the &quot;HTTP Method&quot; panel to copy the URL for your function.</p>
<img src="https://i.imgur.com/pg2wiv4.png">

<p>Running curl on the URL will then execute your function and give you the result.</p>
<pre><code>$ curl https://openwhisk.ng.bluemix.net/api/v1/web/val%40karpov.io_dev/hello-world/helloworld.json
{
  &quot;greeting&quot;: &quot;Hello stranger!&quot;
}
$</code></pre><h2 id="connecting-to-mongodb-and-reusing-the-connection">Connecting to MongoDB and Reusing the Connection</h2>
<p>Currently, you can&#39;t install custom npm packages for IBM Cloud Functions through
the browser GUI, you need to <a href="https://www.ibm.com/blogs/bluemix/2016/12/node-js-code-openwhisk-actions/">bundle your <code>node_modules</code> and upload your function via the CLI</a>.
However, the <a href="https://github.com/apache/incubator-openwhisk/blob/master/docs/reference.md#javascript-runtime-environments">IBM Cloud Function runtime has the mongodb driver pre-installed</a>. This means you can start using the
MongoDB driver without any extra steps. Below is a simple function that connects
to <a href="https://www.mongodb.com/cloud/atlas">MongoDB Atlas</a> with the sensitive credentials omitted. IBM Cloud Functions use Node.js 8 by default, which means
you can use <a href="http://thecodebarbarian.com/80-20-guide-to-async-await-in-node.js.html">async/await</a>.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> mongodb = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>);
<span class="hljs-keyword">const</span> pkg = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb/package.json'</span>);

<span class="hljs-keyword">const</span> uri = <span class="hljs-string">'mongodb+srv://OMITTED.mongodb.net/test'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span>(<span class="hljs-params">params</span>) </span>{
  <span class="hljs-keyword">const</span> driverVersion = pkg.version;
  <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">await</span> mongodb.MongoClient.connect(uri);

  <span class="hljs-keyword">const</span> docs = <span class="hljs-keyword">await</span> client.db(<span class="hljs-string">'test'</span>).collection(<span class="hljs-string">'tests'</span>).find().toArray();

  <span class="hljs-keyword">return</span> { body: { result: docs, driverVersion } };
}

exports.main = main;</code></pre>
<p>You can click the &quot;Invoke&quot; button to run your function without having to switch
to the command line and use curl. Below is the output of running the above function.
Notice that the current MongoDB driver version is 3.0.4, which is the latest version when this article was written.</p>
<img src="https://i.imgur.com/gMA70S4.png">

<p>So the only problem now is that this function creates a new connection to
MongoDB Atlas every time. The 900ms runtime is indicative of the fact that
the MongoDB driver needs to connect to a MongoDB instance running on AWS every
time.</p>
<p>Thankfully, the same trick for reusing connections that works for <a href="https://www.mongodb.com/blog/post/serverless-development-with-nodejs-aws-lambda-mongodb-atlas">Lambda</a> and Azure Functions also works for IBM Cloud. Global-scoped
variables may be persisted between calls, so if you keep a global reference to
your database client you can reuse it.</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> mongodb = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>);

<span class="hljs-keyword">const</span> uri = <span class="hljs-string">'mongodb+srv://OMITTED.mongodb.net/test'</span>;

<span class="hljs-keyword">let</span> client = <span class="hljs-literal">null</span>;

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span>(<span class="hljs-params">params</span>) </span>{
  <span class="hljs-keyword">const</span> reused = client != <span class="hljs-literal">null</span>;
  <span class="hljs-keyword">if</span> (client == <span class="hljs-literal">null</span>) {
    client = <span class="hljs-keyword">await</span> mongodb.MongoClient.connect(uri);  
  }

  <span class="hljs-keyword">const</span> docs = <span class="hljs-keyword">await</span> client.db(<span class="hljs-string">'test'</span>).collection(<span class="hljs-string">'tests'</span>).find().toArray();

  <span class="hljs-keyword">return</span> { body: { result: docs, reused } };
}

exports.main = main;</code></pre>
<p>Below are two executions of this action back-to-back. Notice that the second
execution is much faster because it reused the database connection.</p>
<img src="https://i.imgur.com/x4momOu.png">

<h2 id="moving-on">Moving On</h2>
<p>IBM Cloud Functions are an appealing alternative to AWS Lambda and Azure Functions.
I haven&#39;t tried their CLI yet, but between the built-in npm modules and the
fact that they use Node.js 8 by default, getting started is very easy and you
can get a lot done even without the CLI. I have yet to use IBM Cloud Functions for a production application, but so far IBM Cloud Functions look promising and I look forward to trying them out for a real app.</p>
</div><div style="color: #666666; border-top: 1px dashed #666666; margin: 25px; text-align: center; padding-top: 10px"><em>Found a typo or error? Open up a pull request! This post is
available as markdown on&nbsp;<a href="https://github.com/vkarpov15/thecodebarbarian.com/blob/master/lib/posts/#{post.src.substr('./lib/posts/'.length)}">Github</a></em></div><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'codebarbarian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a class="dsq-brlink" href="http://disqus.com">comments powered by <span class="logo-disqus">Disqus</span></a></div></div><div style="padding-bottom: 100px">&nbsp;</div><script type="text/javascript">var xhr = new XMLHttpRequest();
xhr.open('POST', 'https://g0a3nbw0xa.execute-api.us-east-1.amazonaws.com/prod/track', true);
xhr.setRequestHeader('Content-Type', 'application/json');
xhr.onreadystatechange = function() {};
xhr.send(JSON.stringify({
  path: window.location.pathname,
  hostname: window.location.hostname
}));</script><link rel="stylesheet" href="/style/inlinecpc.css"></body></html>